@using FinanceManager.Shared.Dtos
@using FinanceManager.Shared.Dtos.Admin
@inject FinanceManager.Shared.IApiClient Api
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Components.BackgroundTaskStatusPanel> Localizer
@code {
    [Parameter] public int PollInterval { get; set; } = 2000; // ms
    [Parameter] public BackgroundTaskType[]? AllowedTypes { get; set; } // optional filter only for deciding visibility

    private List<BackgroundTaskInfo> Tasks = new(); // always holds ALL active/queued tasks
    private BackgroundTaskInfo? ActiveTask => Tasks.FirstOrDefault(t => t.Status == BackgroundTaskStatus.Running);
    private List<BackgroundTaskInfo> QueuedTasks => Tasks.Where(t => t.Status == BackgroundTaskStatus.Queued).OrderBy(t => t.EnqueuedUtc).ToList();

    private CancellationTokenSource? _cts;
    private bool _loopStarted;
    private bool _shouldShow; // render flag (based on AllowedTypes subset)

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_loopStarted)
        {
            _loopStarted = true;
            _cts = new CancellationTokenSource();
            _ = PollLoopAsync(_cts.Token);
            await LoadTasksAsync(_cts.Token); // initial fetch
        }
    }

    private async Task PollLoopAsync(CancellationToken ct)
    {
        while (!ct.IsCancellationRequested)
        {
            try
            {
                await Task.Delay(PollInterval, ct);
                if (ct.IsCancellationRequested) { break; }
                await LoadTasksAsync(ct);
            }
            catch (OperationCanceledException) { break; }
            catch { /* ignore transient */ }
        }
    }

    private async Task LoadTasksAsync(CancellationToken ct = default)
    {
        try
        {
            var result = (await Api.BackgroundTasks_GetActiveAsync(ct)).ToList();

            // Determine visibility using AllowedTypes filter, but always keep full list for display
            if (AllowedTypes != null && AllowedTypes.Length > 0)
            {
                _shouldShow = result.Any(t => AllowedTypes.Contains(t.Type));
            }
            else
            {
                _shouldShow = result.Any();
            }
            Tasks = result; // show EVERYTHING if visible
            await InvokeAsync(StateHasChanged);
        }
        catch (OperationCanceledException) { }
        catch { }
    }

    public async Task CancelTaskAsync(Guid id)
    {
        try { await Api.BackgroundTasks_CancelOrRemoveAsync(id, _cts?.Token ?? CancellationToken.None); } catch { }
        await LoadTasksAsync(_cts?.Token ?? CancellationToken.None);
    }

    public async Task RemoveQueuedAsync(Guid id)
    {
        try { await Api.BackgroundTasks_CancelOrRemoveAsync(id, _cts?.Token ?? CancellationToken.None); } catch { }
        await LoadTasksAsync(_cts?.Token ?? CancellationToken.None);
    }

    private string GetTypeLabel(BackgroundTaskType type)
    {
        var key = $"Bgt_Type_{type}";
        var loc = Localizer[key];
        return loc.ResourceNotFound ? type.ToString() : loc.Value;
    }

    public void Dispose()
    {
        try { _cts?.Cancel(); } catch { }
        _cts?.Dispose();
    }
}
@if (_shouldShow)
{
<div class="bgt-panel">
    <h3>@Localizer["Bgt_Title"]</h3>

    <section class="bgt-active-section">
        <h4>@Localizer["Bgt_ActiveTitle"]</h4>
        @if (ActiveTask is null)
        {
            <div class="bgt-empty">@Localizer["Bgt_ActiveNone"]</div>
        }
        else
        {
            <div class="bgt-active">
                <div class="bgt-row">
                    <span class="bgt-type">@GetTypeLabel(ActiveTask.Type)</span>
                    <span class="bgt-status bgt-badge bgt-@ActiveTask.Status.ToString().ToLowerInvariant()">@Localizer[$"Bgt_Status_{ActiveTask.Status}"]</span>
                    <button class="icon-btn" @onclick="() => CancelTaskAsync(ActiveTask.Id)" title="@Localizer["Bgt_Cancel"]"><svg><use href="/icons/sprite.svg#clear" /></svg></button>
                </div>
                <div class="bgt-progress">
                    @if (ActiveTask.Total.HasValue && ActiveTask.Total > 0)
                    {
                        var pct = (int)Math.Round(100.0 * (ActiveTask.Processed ?? 0) / ActiveTask.Total.Value);
                        <div class="bgt-bar" title="@pct%"><div class="bgt-bar-fill" style="width:@pct%"></div></div>
                        <div class="bgt-progress-label">@(ActiveTask.Processed ?? 0) / @(ActiveTask.Total ?? 0)</div>
                    }
                    else
                    {
                        <div class="bgt-indeterminate" title="@Localizer["Bgt_ActiveTitle"]"></div>
                    }
                </div>
                @if(ActiveTask.Total2.HasValue && ActiveTask.Total2 > 0)
                {
                    var subPct = (int)Math.Round(100.0 * (ActiveTask.Processed2 ?? 0) / ActiveTask.Total2.Value);
                    <div class="bgt-progress sub">
                        <div class="bgt-bar" title="@subPct%"><div class="bgt-bar-fill bgt-bar-fill-sub" style="width:@subPct%"></div></div>
                        <div class="bgt-progress-label">@(ActiveTask.Processed2 ?? 0) / @(ActiveTask.Total2 ?? 0)</div>
                    </div>
                }
                @if (!string.IsNullOrWhiteSpace(ActiveTask.Message))
                {
                    <div class="bgt-message">@ActiveTask.Message</div>
                }
                @if (!string.IsNullOrWhiteSpace(ActiveTask.Message2))
                {
                    <div class="bgt-message bgt-message-secondary">@ActiveTask.Message2</div>
                }
                <div class="bgt-metrics">
                    <span class="bgt-warn">@Localizer["Bgt_Warnings"]: @ActiveTask.Warnings</span>
                    <span class="bgt-err">@Localizer["Bgt_Errors"]: @ActiveTask.Errors</span>
                </div>
            </div>
        }
    </section>

    <section class="bgt-queue-section">
        <h4>@Localizer["Bgt_QueuedTitle"]</h4>
        @if (!QueuedTasks.Any())
        {
            <div class="bgt-empty">@Localizer["Bgt_ActiveNone"]</div>
        }
        else
        {
            <ul class="bgt-queue">
                @foreach (var (task, idx) in QueuedTasks.Select((t, i) => (t, i)))
                {
                    <li class="bgt-queue-item">
                        <span class="bgt-type">@GetTypeLabel(task.Type)</span>
                        <span class="bgt-status bgt-badge bgt-queued">@Localizer[$"Bgt_Status_{task.Status}"]</span>
                        <span class="bgt-position">@Localizer["Bgt_Position"]: @(idx + 1)</span>
                        <button class="icon-btn" @onclick="() => RemoveQueuedAsync(task.Id)" title="@Localizer["Bgt_Remove"]"><svg><use href="/icons/sprite.svg#delete" /></svg></button>
                    </li>
                }
            </ul>
        }
    </section>
</div>
}
