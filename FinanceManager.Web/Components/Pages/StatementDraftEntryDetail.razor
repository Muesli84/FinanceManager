@page "/statement-drafts/{DraftId:guid}/entries/{EntryId:guid}"
@rendermode InteractiveServer
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS
@using FinanceManager.Domain.Statements
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<Components.Pages.StatementDraftEntryDetail> Localizer
<PageTitle>@Localizer["PageTitle"]</PageTitle>

@code { enum StatementDraftStatus { Draft=0, Committed=1, Expired=2 } }

<h3>@Localizer["Title"]</h3>
@if (_vm == null)
{
    <p>@Localizer["Loading"]</p>
}
else
{
    <div class="action-bar" style="margin-bottom:1rem;display:flex;gap:.4rem;flex-wrap:wrap;align-items:center;">
        <div style="margin-left:1rem;display:flex;gap:.25rem;align-items:center;">
            <button class="icon-btn" @onclick="BackAsync" title='@Localizer["BtnBack"]' aria-label='@Localizer["BtnBack"]'><svg><use href="/icons/sprite.svg#back" /></svg></button>
        </div>
        <div style="margin-left:1rem;display:flex;gap:.25rem;align-items:center;">
            <button class="icon-btn" disabled="@(_pendingSave)" @onclick="SaveAll" title='@Localizer["BtnSave"]' aria-label='@Localizer["BtnSave"]'><svg><use href="/icons/sprite.svg#save" /></svg></button>
            <button class="icon-btn" @onclick="Reclassify" disabled="@_hasUnsavedChanges" title='@Localizer["BtnReclassify"]' aria-label='@Localizer["BtnReclassify"]'><svg><use href="/icons/sprite.svg#refresh" /></svg></button>
            <button class="icon-btn" @onclick="ValidateEntry" disabled="@_hasUnsavedChanges" title='@Localizer["BtnValidate"]' aria-label='@Localizer["BtnValidate"]'>
                <svg><use href="/icons/sprite.svg#check" /></svg>
            </button>
            <button class="icon-btn" @onclick="OpenSplitDialog" disabled="@_hasUnsavedChanges" title='@Localizer["BtnAssignSplit"]' aria-label='@Localizer["BtnAssignSplit"]'>
                <svg><use href="/icons/sprite.svg#link" /></svg>
            </button>
            <button class="icon-btn" @onclick="BookEntry" disabled="@_hasUnsavedChanges" title='@Localizer["BtnBook"]' aria-label='@Localizer["BtnBook"]'>
                <svg><use href="/icons/sprite.svg#postings" /></svg>
            </button>
            <button class="icon-btn danger" @onclick="DeleteEntry" disabled="@_hasUnsavedChanges" title='@Localizer["BtnDelete"]' aria-label='@Localizer["BtnDelete"]'>
                <svg><use href="/icons/sprite.svg#clear" /></svg>
            </button>
        </div>
        <div style="margin-left:1rem;display:flex;gap:.25rem;align-items:center;">
            <button class="icon-btn" disabled="@(_selectedContactId==null || _hasUnsavedChanges)" @onclick="OpenContactDetail" title='@Localizer["BtnOpenContact"]' aria-label='@Localizer["BtnOpenContact"]'>
                <svg><use href="/icons/sprite.svg#groups" /></svg>
            </button>
            <button class="icon-btn" disabled="@(_selectedSecurityId == null || _hasUnsavedChanges)" title='@Localizer["BtnOpenSecurity"]' aria-label='@Localizer["BtnOpenSecurity"]' @onclick="OpenSecurityDetail">
                <svg><use href="/icons/sprite.svg#security" /></svg>
            </button>
            <button class="icon-btn" disabled="@(_selectedSavingsPlanId == null || _hasUnsavedChanges)" title='@Localizer["BtnOpenSavingsPlan"]' aria-label='@Localizer["BtnOpenSavingsPlan"]' @onclick="OpenSavingsPlanDetail">
                <svg><use href="/icons/sprite.svg#external" /></svg>
            </button>
            @if(_vm?.Entry.SplitDraftId != null)
            {
                <button class="icon-btn" @onclick="OpenAssignedSplitDraft" title='@Localizer["BtnOpenLinkedSplit"]' aria-label='@Localizer["BtnOpenLinkedSplit"]'>
                    <svg><use href="/icons/sprite.svg#external" /></svg>
                </button>
                <button class="icon-btn" @onclick="RemoveSplit" title='@Localizer["BtnRemoveAssignment"]' aria-label='@Localizer["BtnRemoveAssignment"]'>
                    <svg><use href="/icons/sprite.svg#unlink" /></svg>
                </button>
            }
        </div>
        <div style="margin-left:1rem;display:flex;gap:.25rem;align-items:center;">
            <button class="icon-btn" disabled="@(_vm?.PrevEntryId==null)" @onclick="GoPrevAsync" title='@Localizer["BtnPrevEntry"]' aria-label='@Localizer["BtnPrevEntry"]'><svg><use href="/icons/sprite.svg#back" /></svg></button>
            <button class="icon-btn" disabled="@(_vm?.NextOpenEntryId==null)" @onclick="GoNextOpenAsync" title='@Localizer["BtnNextOpenEntry"]' aria-label='@Localizer["BtnNextOpenEntry"]'>
                <svg><use href="/icons/sprite.svg#arrow-right" /></svg>
            </button>
        </div>
    </div>
    <p><strong>@Localizer["DraftFile"]</strong> @_vm.OriginalFileName</p>
    @if(_entryValidation != null)
    {
        <div style="margin-bottom:1rem;padding:.5rem .75rem;border:1px solid #444;border-radius:4px;background:#181818;max-width:960px;">
            <h4 style="margin:.2rem 0 .4rem 0;font-size:.8rem;">@Localizer["Validation_Header"]</h4>
            @if(!_entryValidation.Messages.Any())
            {
                <p style="margin:0;font-size:.7rem;color:#6c6;">@Localizer["Validation_NoIssues"]</p>
            }
            else
            {
                <ul style="margin:.25rem 0 0 1rem;padding:0;font-size:.65rem;">
                    @foreach(var m in _entryValidation.Messages)
                    {
                        var c = m.Severity=="Error"?"#e66":"#cc6";
                        <li style="margin:.2rem 0;color:@c;">@m.Message</li>
                    }
                </ul>
            }
        </div>
    }
    @if(_showBookWarnings && _lastBookingResult != null)
    {
        <div class="panel" style="margin-bottom:1rem;padding:.5rem .75rem;border:1px solid #665;border-radius:4px;background:#2a1f1f;max-width:960px;">
            <h4 style="margin:.2rem 0 .4rem 0;font-size:.8rem;">@Localizer["Warnings"]</h4>
            <ul style="margin:.25rem 0 0 1rem;padding:0;font-size:.65rem;">
                @foreach(var m in _lastBookingResult.Validation.Messages.Where(m=>m.Severity=="Warning"))
                {
                    <li style="margin:.2rem 0;color:#cc6;">@m.Message</li>
                }
            </ul>
            <div style="margin-top:.5rem;display:flex;gap:.5rem;">
                <button class="icon-btn" @onclick="ConfirmBookEntry"><svg><use href="/icons/sprite.svg#check" /></svg>&nbsp;@Localizer["BtnBookAnyway"]</button>
                <button class="icon-btn" @onclick="(()=>{_showBookWarnings=false;})"><svg><use href="/icons/sprite.svg#clear" /></svg>&nbsp;@Localizer["Cancel"]</button>
            </div>
        </div>
    }
    <div style="margin-bottom:1rem;">
        <label><input type="checkbox" @bind="_editMode" /> @Localizer["EditMode"]</label>
        @if (_editMode && _vm != null)
        {
            <div class="edit-core" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.75rem;margin-top:.5rem;max-width:960px;">
                <div>
                    <label>@Localizer["Label_BookingDate"]</label>
                    <InputDate @bind-Value="_editBookingDate" />
                </div>
                <div>
                    <label>@Localizer["Label_ValutaDate"]</label>
                    <InputDate @bind-Value="_editValutaDate" />
                </div>
                <div>
                    <label>@Localizer["Label_Amount"]</label>
                    <InputNumber @bind-Value="_editAmount" />
                </div>
                <div>
                    <label>@Localizer["Label_Currency"]</label>
                    <InputText @bind-Value="_editCurrency" />
                </div>
                <div style="grid-column:1/-1;">
                    <label>@Localizer["Label_Subject"]</label>
                    <InputText @bind-Value="_editSubject" style="width:100%;" />
                </div>
                <div style="grid-column:1/-1;">
                    <label>@Localizer["Label_Recipient"]</label>
                    <InputText @bind-Value="_editRecipient" style="width:100%;" />
                </div>
                <div style="grid-column:1/-1;">
                    <label>@Localizer["Label_Description"]</label>
                    <textarea @bind="_editDescription" rows="3" style="width:100%;"></textarea>
                </div>
                <div style="grid-column:1/-1;display:flex;gap:.5rem;">
                    <button class="icon-btn" disabled="@_savingCore" @onclick="SaveCoreAsync"><svg><use href="/icons/sprite.svg#save" /></svg>&nbsp;@Localizer["BtnSave"]</button>
                    <button type="button" class="icon-btn" disabled="@_savingCore" @onclick="ResetCoreEdits">@Localizer["BtnReset"]</button>
                </div>
                @if(!string.IsNullOrEmpty(_coreError))
                {
                    <div style="grid-column:1/-1;color:#f77;font-size:.8rem;">@_coreError</div>
                }
            </div>
        }
    </div>
    <table class="fm-table" style="max-width:960px;">
        <tbody>
            <tr><th style="width:180px;">@Localizer["Th_BookingDate"]</th><td>@_vm.Entry.BookingDate.ToShortDateString()</td></tr>
            <tr><th>@Localizer["Th_ValutaDate"]</th><td>@(_vm.Entry.ValutaDate?.ToShortDateString() ?? "-")</td></tr>
            <tr>
                <th>@Localizer["Th_Amount"]</th>
                <td>
                    @_vm.Entry.Amount @_vm.Entry.CurrencyCode
                    @if(_vm.SplitSum != null)
                    {
                        <span style="opacity:.7;"> (@Localizer["SplitSum"]: @_vm.SplitSum
                            @if(_vm.Difference is decimal d && d != 0)
                            {
                                <text>; @Localizer["Diff"]: @d</text>
                            }
                            )</span>
                    }
                </td>
            </tr>
            <tr><th>@Localizer["Th_Subject"]</th><td class="wrap">@_vm.Entry.Subject</td></tr>
            <tr><th>@Localizer["Th_Recipient"]</th><td class="wrap">@(_vm.Entry.RecipientName ?? "-")</td></tr>
            <tr><th>@Localizer["Th_Description"]</th><td class="wrap">@(_vm.Entry.BookingDescription ?? "-")</td></tr>
            <tr><th>@Localizer["Th_Announced"]</th><td>@(_vm.Entry.IsAnnounced ? Localizer["Yes"] : Localizer["No"])</td></tr>
            <tr><th>@Localizer["Th_Status"]</th><td>@_vm.Entry.Status</td></tr>
            <tr>
                <th>@Localizer["Th_Contact"]</th>
                <td>
                    <div class="contact-combobox" style="display:grid;grid-template-columns:1fr auto;align-items:start;gap:.5rem;max-width:420px;margin-bottom:1rem;">
                        <div style="position:relative;min-width:0;">
                            <input type="text" style="width:95%;" @bind="_contactFilter" @bind:event="oninput" @bind:after="(()=>OnContactFilterAfterChanged())" placeholder='@Localizer["Placeholder_FilterContacts"]' @onfocus="ShowDropdown" />
                            <input type="hidden" value="@_selectedContactId" />
                            @if (_dropdownVisible)
                            {
                                <ul class="combo-list" style="list-style:none;margin:0;padding:.25rem .25rem;position:absolute;z-index:10;left:0;right:0;max-height:9.5rem;overflow:auto;background:#222;border:1px solid #444;border-radius:4px;box-shadow:0 3px 12px #0005;">
                                    <li style="padding:.3rem .4rem;cursor:pointer;" @onclick="(()=>SelectContact(null))" class="@( _selectedContactId==null?"active":string.Empty)">-- @Localizer["None"] --</li>
                                    @foreach(var c in FilteredContacts)
                                    {
                                        <li style="padding:.3rem .4rem;cursor:pointer;" @onclick="(()=>SelectContact(c.Id))" class="@( _selectedContactId==c.Id?"active":string.Empty)" title="@c.Name">@c.Name</li>
                                    }
                                    @if(!FilteredContacts.Any())
                                    {
                                        <li style="padding:.3rem .4rem;opacity:.6;">@Localizer["NoMatches"]</li>
                                    }
                                </ul>
                            }
                            @if(!string.IsNullOrEmpty(_contactError))
                            {
                                <div style="color:#e66;font-size:.8rem;margin-top:.3rem;">@_contactError</div>
                            }
                        </div>
                        <div>
                            <button class="icon-btn" title='@Localizer["BtnNewContact"]' aria-label='@Localizer["BtnNewContact"]' @onclick="OpenCreateContact"><svg><use href="/icons/sprite.svg#plus" /></svg></button>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <th>@Localizer["Th_CostNeutral"]</th>
                <td><InputCheckbox @bind-Value="IsCostNeutral" @bind-Value:after="(()=> MarkDirty())" /></td>
            </tr>
            <tr>
                <th>@Localizer["Th_SavingsPlan"]</th>
                <td>
                    <div class="savingsplan-combobox" style="display:grid;grid-template-columns:1fr auto;align-items:start;gap:.5rem;max-width:420px;margin-bottom:.75rem;">
                        <div style="position:relative;min-width:0;">
                            <input type="text" style="width:95%;" @bind="_savingsPlanFilter" @bind:event="oninput" @bind:after="(()=>OnSavingsPlanFilterAfterChanged())" placeholder='@Localizer["Placeholder_FilterSavingsPlans"]' @onfocus="ShowSavingsPlanDropdown" />
                            <input type="hidden" value="@_selectedSavingsPlanId" />
                            @if (_savingsPlanDropdownVisible)
                            {
                                <ul class="combo-list" style="list-style:none;margin:0;padding:.25rem .25rem;position:absolute;z-index:10;left:0;right:0;max-height:9.5rem;overflow:auto;background:#222;border:1px solid #444;border-radius:4px;box-shadow:0 3px 12px #0005;">
                                    <li style="padding:.3rem .4rem;cursor:pointer;" @onclick="(()=>SelectSavingsPlan(null))" class="@( _selectedSavingsPlanId==null?"active":string.Empty)">-- @Localizer["None"] --</li>
                                    @foreach(var plan in FilteredSavingsPlans)
                                    {
                                        <li style="padding:.3rem .4rem;cursor:pointer;" @onclick="(()=>SelectSavingsPlan(plan.Id))" class="@( _selectedSavingsPlanId==plan.Id?"active":string.Empty)" title="@plan.Name">@plan.Name</li>
                                    }
                                    @if(!FilteredSavingsPlans.Any())
                                    {
                                        <li style="padding:.3rem .4rem;opacity:.6;">@Localizer["NoMatches"]</li>
                                    }
                                </ul>
                            }
                        </div>
                        <div style="display:flex;gap:.35rem;">
                            <button class="icon-btn" title='@Localizer["BtnNewSavingsPlan"]' aria-label='@Localizer["BtnNewSavingsPlan"]' @onclick="OpenCreateSavingsPlan" disabled="@(!CanCreateSavingsPlan)"><svg><use href="/icons/sprite.svg#plus" /></svg></button>
                        </div>
                    </div>
                    @if(_selectedSavingsPlanId != null)
                    {
                        <div style="display:flex;align-items:center;gap:.5rem;margin:.25rem 0 .5rem 0;max-width:420px;">
                            <InputCheckbox @bind-Value="_archiveSavingsPlanOnBooking" @bind-Value:after="(()=> MarkDirty())" />
                            <span>@Localizer["ArchiveSavingsPlanOnBooking"]</span>
                        </div>
                    }
                </td>
            </tr>
            @if(ShowSecuritySection)
            {
                <tr>
                    <th>@Localizer["Th_Security"]</th>
                    <td>
                        <div style="display:grid;grid-template-columns:1fr auto;align-items:start;gap:.5rem;max-width:480px;margin-bottom:.75rem;">
                            <div style="position:relative;min-width:0;">
                                <input type="text"
                                       style="width:95%;"
                                       @bind="_securityFilter"
                                       @bind:event="oninput"
                                       @bind:after="(()=>OnSecurityFilterChanged())"
                                       placeholder='@Localizer["Placeholder_FilterSecurities"]'
                                       @onfocus="ShowSecurityDropdown" />
                                <input type="hidden" value="@_selectedSecurityId" />
                                @if (_securityDropdownVisible)
                                {
                                    <ul class="combo-list" style="list-style:none;margin:0;padding:.25rem .25rem;position:absolute;z-index:10;left:0;right:0;max-height:9.5rem;overflow:auto;background:#222;border:1px solid #444;border-radius:4px;box-shadow:0 3px 12px #0005;">
                                        <li style="padding:.3rem .4rem;cursor:pointer;"
                                            @onclick="(()=>SelectSecurity(null))"
                                            class="@(_selectedSecurityId==null?"active":string.Empty)">-- @Localizer["None"] --</li>
                                        @foreach(var s in FilteredSecurities)
                                        {
                                            <li style="padding:.3rem .4rem;cursor:pointer;"
                                                @onclick="(()=>SelectSecurity(s.Id))"
                                                class="@(_selectedSecurityId==s.Id?"active":string.Empty)"
                                                title="@s.Name">@s.Name (@s.Identifier)</li>
                                        }
                                        @if(!FilteredSecurities.Any())
                                        {
                                            <li style="padding:.3rem .4rem;opacity:.6;">@Localizer["NoMatches"]</li>
                                        }
                                    </ul>
                                }
                                @if(!string.IsNullOrEmpty(_securityError))
                                {
                                    <div style="margin-top:.3rem;color:#e66;font-size:.75rem;">@_securityError</div>
                                }
                            </div>
                            <div>
                                <button class="icon-btn" title='@Localizer["BtnNewSecurity"]' aria-label='@Localizer["BtnNewSecurity"]' @onclick="OpenCreateSecurity"><svg><use href="/icons/sprite.svg#plus" /></svg></button>                                
                            </div>
                        </div>
                        @if (_selectedSecurityId != null)
                        {
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.6rem;max-width:720px;margin-top:.25rem;">
                                <div>
                                    <label>@Localizer["Label_TxType"]</label>
                                    <select @bind="_securityTxType" @bind:after="()=> MarkDirty()">
                                        <option value="">--</option>
                                        <option value="Buy">@Localizer["Tx_Buy"]</option>
                                        <option value="Sell">@Localizer["Tx_Sell"]</option>
                                        <option value="DividendOrInterest">@Localizer["Tx_DividendOrInterest"]</option>
                                    </select>
                                </div>
                                <div>
                                    <label>@Localizer["Label_Quantity"]</label>
                                    <input type="text" @bind="_securityQuantityExpr" @bind:event="oninput" @bind:after="MarkDirty" @onblur="ParseSecurityQuantity" />
                                </div>
                                <div>
                                    <label>@Localizer["Label_Fee"]</label>
                                    <input type="text" @bind="_securityFeeExpr" @bind:event="oninput" @bind:after="MarkDirty" @onblur="ParseSecurityFee" />
                                </div>
                                <div>
                                    <label>@Localizer["Label_Tax"]</label>
                                    <input type="text" @bind="_securityTaxExpr" @bind:event="oninput" @bind:after="MarkDirty" @onblur="ParseSecurityTax" />
                                </div>
                            </div>
                            @if(!string.IsNullOrEmpty(_securityExprError))
                            {
                                <div style="margin-top:.25rem;color:#e66;font-size:.75rem;">@_securityExprError</div>
                            }
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (_showSplitDialog)
    {
        <div class="modal-backdrop split-center">
            <div class="modal split-dialog" role="dialog" aria-modal="true" aria-label='@Localizer["Split_SelectTitle"]'>
                <h3 style="margin-top:0;">@Localizer["Split_SelectTitle"]</h3>
                @if(_vm?.Entry.SplitDraftId != null)
                {
                    <p style="margin:.15rem 0 .4rem 0;font-size:.7rem;opacity:.7;">@Localizer["Split_CurrentlyLinked"] @_vm.Entry.SplitDraftId</p>
                }
                <p style="margin-top:.2rem;opacity:.8;font-size:.85rem;">@Localizer["Split_SelectHint"]</p>
                <input type="text" @bind="_splitFilter" placeholder='@Localizer["Filter"]' style="width:100%;margin:.5rem 0 .75rem 0;" />
                <div class="split-scroll">
                    @if(_loadingSplits)
                    {
                        <div class="split-hint">@Localizer["Loading"]</div>
                    }
                    else
                    {
                        @foreach(var d in FilteredSplitDrafts)
                        {
                            <div class="split-row @(d.DraftId==_selectedSplitDraftId? "active" : string.Empty)" @onclick="(()=>SelectSplit(d.DraftId))">
                                <div class="name">@d.OriginalFileName</div>
                                <div class="meta">@d.EntriesCount @Localizer["Entries"] · @Localizer["Total"] @d.TotalAmount</div>
                            </div>
                        }
                        @if(!FilteredSplitDrafts.Any())
                        {
                            <div class="split-hint">@Localizer["NoMatches"]</div>
                        }
                    }
                </div>
                @if(!string.IsNullOrEmpty(_splitError))
                {
                    <div class="split-error">@_splitError</div>
                }
                <div class="split-actions">
                    <button class="icon-btn" disabled="@(_selectedSplitDraftId==null)" @onclick="ConfirmSplit" title='@Localizer["Apply"]' aria-label='@Localizer["Apply"]'><svg><use href="/icons/sprite.svg#check" /></svg></button>
                    <button class="icon-btn" @onclick="CloseSplitDialog" title='@Localizer["Cancel"]' aria-label='@Localizer["Cancel"]'><svg><use href="/icons/sprite.svg#clear" /></svg></button>
                </div>
            </div>
        </div>
    }
}

@code {
    [Parameter] public Guid DraftId { get; set; }
    [Parameter] public Guid EntryId { get; set; }

    private EntryDetailVm? _vm;
    private List<ContactVm> _allContacts = new();
    private string _contactFilter = string.Empty;
    private Guid? _selectedContactId;
    private Guid? _selfContactId;
    private string? _contactError;
    private bool _dropdownVisible;
    private bool _pendingSave;
    private bool _IsCostNeutral;
    private bool IsCostNeutral { get => _IsCostNeutral; set { _IsCostNeutral = value; } }

    private bool _hasUnsavedChanges;
    private void MarkDirty() => _hasUnsavedChanges = true;
    private void ClearDirty() => _hasUnsavedChanges = false;

    private IEnumerable<ContactVm> FilteredContacts => string.IsNullOrWhiteSpace(_contactFilter)
        ? _allContacts
        : _allContacts.Where(c => c.Name.Contains(_contactFilter, StringComparison.OrdinalIgnoreCase));

    private Guid? _selectedSavingsPlanId;
    private string _savingsPlanFilter = string.Empty;
    private bool _savingsPlanDropdownVisible;
    private List<SavingsPlanDto> _userSavingsPlans = new();
    private bool _archiveSavingsPlanOnBooking;

    private IEnumerable<SavingsPlanDto> FilteredSavingsPlans => string.IsNullOrWhiteSpace(_savingsPlanFilter)
         ? _userSavingsPlans
         : _userSavingsPlans.Where(p => p.Name.Contains(_savingsPlanFilter, StringComparison.OrdinalIgnoreCase));

    // Split UI
    private bool _showSplitDialog;
    private bool _loadingSplits;
    private string _splitFilter = string.Empty;
    private Guid? _selectedSplitDraftId;
    private string? _splitError;
    private List<SplitDraftOption> _candidateSplits = new();

    private IEnumerable<SplitDraftOption> FilteredSplitDrafts => string.IsNullOrWhiteSpace(_splitFilter)
        ? _candidateSplits
        : _candidateSplits.Where(d => d.OriginalFileName.Contains(_splitFilter, StringComparison.OrdinalIgnoreCase));

    private sealed record SplitDraftOption(Guid DraftId, string OriginalFileName, int EntriesCount, decimal TotalAmount);

    // Core edit
    private bool _editMode; private bool _savingCore; private string? _coreError;
    private DateTime _editBookingDate; private DateTime? _editValutaDate; private decimal _editAmount; private string _editSubject=""; private string? _editRecipient; private string? _editDescription; private string _editCurrency="EUR";

    // Securities UI State
    private List<SecurityVm> _securities = new();
    private string _securityFilter = string.Empty;
    private bool _securityDropdownVisible;
    private Guid? _selectedSecurityId;
    private string? _securityError;
    private SecurityTransactionType? _securityTxType;
    private decimal? _securityQuantity;
    private decimal? _securityFee;
    private decimal? _securityTax;

    // Expression inputs + error
    private string _securityQuantityExpr = string.Empty;
    private string _securityFeeExpr = string.Empty;
    private string _securityTaxExpr = string.Empty;
    private string? _securityExprError;

    private IEnumerable<SecurityVm> FilteredSecurities => string.IsNullOrWhiteSpace(_securityFilter)
        ? _securities
        : _securities.Where(s => s.Name.Contains(_securityFilter, StringComparison.OrdinalIgnoreCase) || s.Identifier.Contains(_securityFilter, StringComparison.OrdinalIgnoreCase));

    // Sichtbar wenn:
    // - Bankkontakt = Empfänger (ursprüngliche Bedingung) ODER
    // - bereits ein Wertpapier zugeordnet ist (sonst würde es beim erneuten Öffnen verschwinden)
    private bool ShowSecuritySection =>
        _vm != null &&
        (
            _vm.Entry.SecurityId != null ||
            (_vm.BankContactId != null &&
             _vm.Entry.ContactId != null &&
             _vm.Entry.ContactId == _vm.BankContactId)
        );

    private void InitCoreEdit()
    {
        if (_vm == null) { return; }
        _editBookingDate = _vm.Entry.BookingDate;
        _editValutaDate = _vm.Entry.ValutaDate;
        _editAmount = _vm.Entry.Amount;
        _editSubject = _vm.Entry.Subject;
        _editRecipient = _vm.Entry.RecipientName;
        _editDescription = _vm.Entry.BookingDescription;
        _editCurrency = _vm.Entry.CurrencyCode;
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadEntryAsync();
        await LoadContactsAsync();
        await LoadUserSavingsPlansAsync();

        _selectedContactId = _vm?.Entry.ContactId;
        _contactFilter = _vm?.Entry.ContactId != null ? _allContacts.FirstOrDefault(c=>c.Id==_vm.Entry.ContactId)?.Name ?? string.Empty : string.Empty;

        _selectedSavingsPlanId = _vm?.Entry.SavingsPlanId;
        _savingsPlanFilter = _selectedSavingsPlanId != null
            ? _userSavingsPlans.FirstOrDefault(p=>p.Id==_selectedSavingsPlanId)?.Name ?? string.Empty
            : string.Empty;
        _archiveSavingsPlanOnBooking = _vm?.Entry.ArchiveSavingsPlanOnBooking ?? false;

        // Securities initialisieren
        if (_vm?.Entry != null)
        {
            _selectedSecurityId = _vm.Entry.SecurityId;
            _securityTxType = _vm.Entry.SecurityTransactionType;
            _securityQuantity = _vm.Entry.SecurityQuantity;
            _securityFee = _vm.Entry.SecurityFeeAmount;
            _securityTax = _vm.Entry.SecurityTaxAmount;
            // init expr fields from values
            _securityQuantityExpr = _securityQuantity?.ToString(System.Globalization.CultureInfo.CurrentCulture) ?? string.Empty;
            _securityFeeExpr = _securityFee?.ToString(System.Globalization.CultureInfo.CurrentCulture) ?? string.Empty;
            _securityTaxExpr = _securityTax?.ToString(System.Globalization.CultureInfo.CurrentCulture) ?? string.Empty;
        }

        await LoadSecuritiesIfNeededAsync();

        if (_selectedSecurityId != null && string.IsNullOrEmpty(_securityFilter))
        {
            _securityFilter = _securities.FirstOrDefault(s => s.Id == _selectedSecurityId)?.Name ?? string.Empty;
        }

        InitCoreEdit();
        ClearDirty();
    }

    private async Task<bool> ConfirmIfDirtyAsync()
    {
        if (!_hasUnsavedChanges) { return true; }
        try
        {
            return await JS.InvokeAsync<bool>("confirm", Localizer["ConfirmUnsavedChanges"].Value);
        }
        catch { return true; }
    }

    private async Task LoadEntryAsync()
    {
        var resp = await Http.GetAsync($"/api/statement-drafts/{DraftId}/entries/{EntryId}");
        if (resp.IsSuccessStatusCode)
        {
            _vm = await resp.Content.ReadFromJsonAsync<EntryDetailVm>();
            _IsCostNeutral = _vm!.Entry.IsCostNeutral;
            _selectedSavingsPlanId = _vm.Entry.SavingsPlanId;
            _selectedContactId = _vm.Entry.ContactId;
            _selectedSecurityId = _vm.Entry.SecurityId;
            _savingsPlanFilter = _selectedSavingsPlanId != null
                ? _userSavingsPlans.FirstOrDefault(p => p.Id == _selectedSavingsPlanId)?.Name ?? string.Empty
                : string.Empty;
            _archiveSavingsPlanOnBooking = _vm.Entry.ArchiveSavingsPlanOnBooking;
        }
        else if (resp.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
            _vm = null;
        }
    }

    private async Task DeleteEntry()
    {
        var resp = await Http.DeleteAsync($"/api/statement-drafts/{DraftId}/entries/{EntryId}");
        if (resp.IsSuccessStatusCode)
        {
            Nav.NavigateTo($"/statement-drafts/{DraftId}");
        }
    }

    private async Task LoadContactsAsync()
    {
        var resp = await Http.GetAsync("/api/contacts?all=true");
        if (resp.IsSuccessStatusCode)
        {
            var list = await resp.Content.ReadFromJsonAsync<List<ContactDto>>() ?? new();
            _allContacts = list.Select(c => new ContactVm { Id = c.Id, Name = c.Name }).OrderBy(c => c.Name).ToList();
            _selfContactId = list.FirstOrDefault(c => c.Type == ContactType.Self)?.Id;
        }
    }

    private async Task LoadUserSavingsPlansAsync()
    {
        var resp = await Http.GetAsync("/api/savings-plans?onlyActive=true");
        if (resp.IsSuccessStatusCode)
        {
            _userSavingsPlans = await resp.Content.ReadFromJsonAsync<List<SavingsPlanDto>>() ?? new();
        }
    }

    private async Task LoadSecuritiesIfNeededAsync()
    {
        if (!ShowSecuritySection && _vm?.Entry.SecurityId == null) { return; }
        if (_securities.Count > 0) { return; }

        var resp = await Http.GetAsync("/api/securities?onlyActive=true");
        if (!resp.IsSuccessStatusCode)
        {
            _securityError = await resp.Content.ReadAsStringAsync();
            return;
        }
        var list = await resp.Content.ReadFromJsonAsync<List<SecurityDto>>() ?? new();
        _securities = list
            .Select(s => new SecurityVm { Id = s.Id, Name = s.Name, Identifier = s.Identifier })
            .OrderBy(s => s.Name)
            .ToList();
    }

    private void ShowSavingsPlanDropdown(FocusEventArgs _) => _savingsPlanDropdownVisible = true;
    private void SelectSavingsPlan(Guid? id)
    {
        if (_selectedSavingsPlanId != id) { _selectedSavingsPlanId = id; MarkDirty(); }
        _savingsPlanFilter = id == null ? string.Empty : _userSavingsPlans.FirstOrDefault(p => p.Id == id)?.Name ?? string.Empty;
        _savingsPlanDropdownVisible = false;
        if (id == null) { _archiveSavingsPlanOnBooking = false; }
    }
    private void OnSavingsPlanFilterAfterChanged()
    {
        _savingsPlanDropdownVisible = true;
        if (_selectedSavingsPlanId != null && !_userSavingsPlans.Any(p => string.Equals(p.Name, _savingsPlanFilter, StringComparison.OrdinalIgnoreCase)))
        {
            _selectedSavingsPlanId = null; MarkDirty();
        }
    }

    private bool CanCreateSavingsPlan =>
        _vm != null &&
        _selfContactId != null &&
        _vm.Entry.ContactId != null &&
        _vm.Entry.ContactId == _selfContactId &&
        _vm.Entry.Amount < 0 &&
        _selectedSavingsPlanId == null;

    private void OpenCreateSavingsPlan()
    {
        if (_vm == null) { return; }
        var name = string.IsNullOrWhiteSpace(_savingsPlanFilter) ? _vm.Entry.Subject : _savingsPlanFilter;
        name ??= string.Empty;
        var url = $"/savings-plans/new?prefillName={Uri.EscapeDataString(name)}&draftId={DraftId}&entryId={EntryId}";
        Nav.NavigateTo(url);
    }

    private async Task BackAsync()
    {
        if (!await ConfirmIfDirtyAsync()) return;
        Nav.NavigateTo($"/statement-drafts/{DraftId}");
    }
    private void OpenCreateContact()
    {
        var name = _vm?.Entry.RecipientName;
        if (string.IsNullOrWhiteSpace(name)) { name = string.IsNullOrWhiteSpace(_contactFilter) ? _vm?.Entry.Subject : _contactFilter; }
        name ??= string.Empty;
        var url = $"/contacts/new?prefillName={Uri.EscapeDataString(name)}&draftId={DraftId}&entryId={EntryId}";
        Nav.NavigateTo(url);
    }
    private void OpenContactDetail()
    {
        if (_selectedContactId != null) { Nav.NavigateTo($"/contacts/{_selectedContactId}?&draftId={DraftId}&entryId={EntryId}"); }
    }
    private void OpenSavingsPlanDetail()
    {
        if (_selectedSavingsPlanId != null) { Nav.NavigateTo($"/savings-plans/{_selectedSavingsPlanId}?&draftId={DraftId}&entryId={EntryId}"); }
    }
    private async Task GoPrevAsync()
    {
        if (!await ConfirmIfDirtyAsync()) return;
        if (_vm?.PrevEntryId != null)
        {
            Nav.NavigateTo($"/statement-drafts/{DraftId}/entries/{_vm.PrevEntryId}");
        }
    }
    private async Task GoNextOpenAsync()
    {
        if (!await ConfirmIfDirtyAsync()) return;
        if (_vm?.NextOpenEntryId != null)
        {
            Nav.NavigateTo($"/statement-drafts/{DraftId}/entries/{_vm.NextOpenEntryId}");
        }
    }

    // Split
    private void OpenSplitDialog()
    {
        _splitError = null;
        _selectedSplitDraftId = null;
        _showSplitDialog = true;
        _ = LoadSplitCandidates();
    }
    private void CloseSplitDialog() => _showSplitDialog = false;
    private async Task LoadSplitCandidates()
    {
        _loadingSplits = true;
        try
        {
            var list = await Http.GetFromJsonAsync<List<StatementDraftListDto>>("/api/statement-drafts");
            if (list != null)
            {
                _candidateSplits = list
                    .Where(d => d.DraftId != DraftId && d.DetectedAccountId == null && !d.IsSplitDraft && d.Status == StatementDraftStatus.Draft)
                    .Select(d => new SplitDraftOption(d.DraftId, d.OriginalFileName, d.Entries.Count, d.TotalAmount))
                    .OrderBy(d => d.OriginalFileName)
                    .ToList();
            }
        }
        finally
        {
            _loadingSplits = false;
            StateHasChanged();
        }
    }
    private void SelectSplit(Guid id) => _selectedSplitDraftId = id;
    private async Task ConfirmSplit()
    {
        if (_selectedSplitDraftId == null) { return; }
        try
        {
            var resp = await Http.PostAsJsonAsync($"/api/statement-drafts/{DraftId}/entries/{EntryId}/split", new { SplitDraftId = _selectedSplitDraftId });
            if (!resp.IsSuccessStatusCode)
            {
                _splitError = await resp.Content.ReadAsStringAsync();
                return;
            }
            _showSplitDialog = false;
            await LoadEntryAsync();
        }
        catch (Exception ex)
        {
            _splitError = ex.Message;
        }
    }
    private async Task RemoveSplit()
    {
        var resp = await Http.PostAsJsonAsync($"/api/statement-drafts/{DraftId}/entries/{EntryId}/split", new { SplitDraftId = (Guid?)null });
        if (resp.IsSuccessStatusCode) { await LoadEntryAsync(); }
    }
    private void OpenAssignedSplitDraft()
    {
        if (_vm?.Entry.SplitDraftId != null)
        {
            Nav.NavigateTo($"/statement-drafts/{_vm.Entry.SplitDraftId}");
        }
    }

    // Core save
    private async Task SaveCoreAsync()
    {
        if (_vm == null) { return; }
        _savingCore = true; _coreError = null;
        try
        {
            var payload = new { BookingDate = _editBookingDate, ValutaDate = _editValutaDate, Amount = _editAmount, Subject = _editSubject, RecipientName = _editRecipient, CurrencyCode = _editCurrency, BookingDescription = _editDescription };
            var resp = await Http.PostAsJsonAsync($"/api/statement-drafts/{DraftId}/entries/{EntryId}/edit-core", payload);
            if (!resp.IsSuccessStatusCode)
            {
                _coreError = await resp.Content.ReadAsStringAsync();
            }
            else
            {
                await LoadEntryAsync();
                InitCoreEdit();
                ClearDirty();
                _editMode = false;
            }
        }
        catch(Exception ex)
        {
            _coreError = ex.Message;
        }
        _savingCore = false;        
    }
    private void ResetCoreEdits() { InitCoreEdit(); ClearDirty(); }

    // Records / DTO shapes
    private sealed record EntryDto(
        Guid Id,
        DateTime BookingDate,
        DateTime? ValutaDate,
        decimal Amount,
        string CurrencyCode,
        string Subject,
        string? RecipientName,
        string? BookingDescription,
        bool IsAnnounced,
        bool IsCostNeutral,
        StatementDraftEntryStatus Status,
        Guid? ContactId,
        Guid? SavingsPlanId,
        bool ArchiveSavingsPlanOnBooking,
        Guid? SplitDraftId,
        Guid? SecurityId,
        SecurityTransactionType? SecurityTransactionType,
        decimal? SecurityQuantity,
        decimal? SecurityFeeAmount,
        decimal? SecurityTaxAmount
    );

    private sealed record EntryDetailVm(
        Guid DraftId,
        string OriginalFileName,
        EntryDto Entry,
        Guid? PrevEntryId,
        Guid? NextEntryId,
        Guid? NextOpenEntryId,
        decimal? SplitSum,
        decimal? Difference,
        Guid? BankContactId
    );

    private sealed record ContactDto(Guid Id, string Name, ContactType Type, Guid? CategoryId);
    private enum ContactType { Self, Bank, Person, Organization, Other }
    private sealed class ContactVm { public Guid Id { get; set; } public string Name { get; set; } = string.Empty; }
    private sealed record SavingsPlanDto(Guid Id, string Name);
    private sealed record StatementDraftListDto(Guid DraftId, string OriginalFileName, Guid? DetectedAccountId, StatementDraftStatus Status, decimal TotalAmount, bool IsSplitDraft, IReadOnlyList<EntryDto> Entries);

    private sealed record SecurityDto(Guid Id, string Name, String Identifier);
    private sealed class SecurityVm { public Guid Id { get; set; } public string Name { get; set; } = string.Empty; public string Identifier { get; set; } = string.Empty; }
    private enum SecurityTransactionType { Buy=0, Sell=1, DividendOrInterest=2 }

    private DraftValidationResultDto? _entryValidation;

    private async Task ValidateEntry()
    {
        if (_hasUnsavedChanges) { return; }
        _entryValidation = await Http.GetFromJsonAsync<DraftValidationResultDto>($"/api/statement-drafts/{DraftId}/entries/{EntryId}/validate");
        StateHasChanged();
    }

    private sealed record DraftValidationMessageDto(string Code, string Severity, string Message, Guid DraftId, Guid? EntryId);
    private sealed record DraftValidationResultDto(Guid DraftId, bool IsValid, IReadOnlyList<DraftValidationMessageDto> Messages);

    private async Task SaveAll()
    {
        if (_vm == null) { return; }
        _pendingSave = true; _contactError = null;
        try
        {
            var payload = new
            {
                ContactId = _selectedContactId,
                IsCostNeutral = _IsCostNeutral,
                SavingsPlanId = _selectedSavingsPlanId,
                ArchiveOnBooking = _archiveSavingsPlanOnBooking,
                SecurityId = _selectedSecurityId,
                TransactionType = _securityTxType,
                Quantity = _securityQuantity,
                FeeAmount = _securityFee,
                TaxAmount = _securityTax
            };

            var resp = await Http.PostAsJsonAsync($"/api/statement-drafts/{DraftId}/entries/{EntryId}/save-all", payload);
            if (!resp.IsSuccessStatusCode)
            {
                _contactError = await resp.Content.ReadAsStringAsync();
            }
            else
            {
                await LoadEntryAsync();
                ClearDirty();
            }
        }
        catch (Exception ex)
        {
            _contactError = ex.Message;
        }
        _pendingSave = false;
    }

    private async Task Reclassify()
    {
        if (_hasUnsavedChanges) { return; }
        var resp = await Http.PostAsync($"/api/statement-drafts/{DraftId}/classify/{_vm?.Entry.Id}", null);
        if (resp.IsSuccessStatusCode)
        {
            await LoadEntryAsync();
            _selectedContactId = _vm?.Entry.ContactId;
            _contactFilter = _selectedContactId == null ? string.Empty : _allContacts.FirstOrDefault(c=>c.Id==_vm.Entry.ContactId)?.Name ?? string.Empty;
            StateHasChanged();
        }
    }

    private void OpenSecurityDetail()
    {
        if (_hasUnsavedChanges) { return; }
        if (_selectedSecurityId != null)
        {
            Nav.NavigateTo($"/securities/{_selectedSecurityId}?draftId={DraftId}&entryId={EntryId}");
        }
    }

    private void ShowDropdown(FocusEventArgs _) => _dropdownVisible = true;
    private void SelectContact(Guid? id)
    {
        if (_selectedContactId != id) { _selectedContactId = id; MarkDirty(); }
        _contactFilter = id == null ? string.Empty : _allContacts.FirstOrDefault(c=>c.Id==id)?.Name ?? string.Empty;
        _dropdownVisible = false;
    }
    private void OnContactFilterAfterChanged()
    {
        _dropdownVisible = true;
        if (_selectedContactId != null && !_allContacts.Any(c => string.Equals(c.Name, _contactFilter, StringComparison.OrdinalIgnoreCase)))
        {
            _selectedContactId = null; MarkDirty();
        }
    }

    private void ShowSecurityDropdown(FocusEventArgs _) => _securityDropdownVisible = true;
    private void OnSecurityFilterChanged()
    {
        _securityDropdownVisible = true;
        if (_selectedSecurityId != null &&
            !_securities.Any(s => string.Equals(s.Name, _securityFilter, StringComparison.OrdinalIgnoreCase)))
        {
            _selectedSecurityId = null; MarkDirty();
        }
    }
    private void SelectSecurity(Guid? id)
    {
        if (_selectedSecurityId != id) { _selectedSecurityId = id; MarkDirty(); }
        _securityFilter = id == null ? string.Empty : _securities.FirstOrDefault(s => s.Id == id)?.Name ?? string.Empty;
        _securityDropdownVisible = false;
    }

    private void OpenCreateSecurity()
    {
        var name = _securityFilter;
        if (string.IsNullOrWhiteSpace(name))
        {
            name = _vm?.Entry.Subject;
        }
        name ??= string.Empty;
        var url = $"/securities/new?prefillName={Uri.EscapeDataString(name)}&draftId={DraftId}&entryId={EntryId}";
        Nav.NavigateTo(url);
    }

    private void ParseSecurityQuantity(FocusEventArgs _)
    {
        if (TryEvalDecimal(_securityQuantityExpr, out var v))
        {
            _securityQuantity = v; _securityQuantityExpr = v?.ToString(System.Globalization.CultureInfo.CurrentCulture) ?? string.Empty; _securityExprError = null; MarkDirty();
        }
        else { _securityExprError = Localizer["Err_InvalidQuantity"]; }
    }
    private void ParseSecurityFee(FocusEventArgs _)
    {
        if (TryEvalDecimal(_securityFeeExpr, out var v))
        {
            _securityFee = v; _securityFeeExpr = v?.ToString(System.Globalization.CultureInfo.CurrentCulture) ?? string.Empty; _securityExprError = null; MarkDirty();
        }
        else { _securityExprError = Localizer["Err_InvalidFee"]; }
    }
    private void ParseSecurityTax(FocusEventArgs _)
    {
        if (TryEvalDecimal(_securityTaxExpr, out var v))
        {
            _securityTax = v; _securityTaxExpr = v?.ToString(System.Globalization.CultureInfo.CurrentCulture) ?? string.Empty; _securityExprError = null; MarkDirty();
        }
        else { _securityExprError = Localizer["Err_InvalidTax"]; }
    }

    private static bool TryEvalDecimal(string? expr, out decimal? value)
    {
        value = null;
        if (string.IsNullOrWhiteSpace(expr)) { return true; }
        try
        {
            var d = Eval(expr);
            value = (decimal)d;
            return true;
        }
        catch
        {
            value = null; return false;
        }
    }

    private static double Eval(string input)
    {
        var expr = new string(input.Where(c => !char.IsWhiteSpace(c)).ToArray());
        expr = expr.Replace(',', '.');
        int i = 0;
        double ParseExpression()
        {
            double x = ParseTerm();
            while (i < expr.Length)
            {
                if (expr[i] == '+') { i++; x += ParseTerm(); }
                else if (expr[i] == '-') { i++; x -= ParseTerm(); }
                else break;
            }
            return x;
        }
        double ParseTerm()
        {
            double x = ParseFactor();
            while (i < expr.Length)
            {
                if (expr[i] == '*') { i++; x *= ParseFactor(); }
                else if (expr[i] == '/') { i++; x /= ParseFactor(); }
                else break;
            }
            return x;
        }
        double ParseFactor()
        {
            if (i >= expr.Length) throw new FormatException();
            if (expr[i] == '+') { i++; return ParseFactor(); }
            if (expr[i] == '-') { i++; return -ParseFactor(); }
            if (expr[i] == '(')
            {
                i++; var v = ParseExpression();
                if (i >= expr.Length || expr[i] != ')') throw new FormatException();
                i++; return v;
            }
            int start = i;
            while (i < expr.Length && (char.IsDigit(expr[i]) || expr[i] == '.')) i++;
            if (start == i) throw new FormatException();
            var token = expr.Substring(start, i - start);
            if (!double.TryParse(token, System.Globalization.NumberStyles.Float, System.Globalization.CultureInfo.InvariantCulture, out var v2))
                throw new FormatException();
            return v2;
        }
        var result = ParseExpression();
        if (i != expr.Length) throw new FormatException();
        return result;
    }

    private bool GetArchiveFlagFromEntryVm()
    {
        try
        {
            return _vm?.Entry.ArchiveSavingsPlanOnBooking ?? false;
        }
        catch { return false; }
    }

    private bool _showBookWarnings;
    private BookingResultDto? _lastBookingResult;

    private async Task BookEntry()
    {
        if (_hasUnsavedChanges) { return; }
        _contactError = null;
        _showBookWarnings = false;
        try
        {
            var resp = await Http.PostAsync($"/api/statement-drafts/{DraftId}/entries/{EntryId}/book", null);
            if (resp.StatusCode == System.Net.HttpStatusCode.PreconditionRequired)
            {
                _lastBookingResult = await resp.Content.ReadFromJsonAsync<BookingResultDto>();
                _showBookWarnings = true;
                StateHasChanged();
                return;
            }
            if (!resp.IsSuccessStatusCode)
            {
                var text = await resp.Content.ReadAsStringAsync();
                _contactError = string.IsNullOrWhiteSpace(text) ? Localizer["Err_Book"] : text;
                return;
            }
            _lastBookingResult = await resp.Content.ReadFromJsonAsync<BookingResultDto>();
            await LoadEntryAsync();
            if (_vm != null && _vm.Entry != null && _vm.Entry.Id == EntryId)
            {
                StateHasChanged();
            }
            else
            {
                Nav.NavigateTo($"/statement-drafts/{DraftId}", true);
            }
        }
        catch (Exception ex)
        {
            _contactError = ex.Message;
        }
    }

    private async Task ConfirmBookEntry()
    {
        var resp = await Http.PostAsync($"/api/statement-drafts/{DraftId}/entries/{EntryId}/book?forceWarnings=true", null);
        if (!resp.IsSuccessStatusCode)
        {
            _contactError = await resp.Content.ReadAsStringAsync();
            return;
        }
        _lastBookingResult = await resp.Content.ReadFromJsonAsync<BookingResultDto>();
        _showBookWarnings = false;
        await LoadEntryAsync();
        Nav.NavigateTo($"/statement-drafts/{DraftId}", true);
    }

    private sealed record BookingResultDto(bool Success, bool HasWarnings, DraftValidationResultDto Validation, Guid? StatementImportId, int? TotalEntries, Guid? nextDraftId);
}
