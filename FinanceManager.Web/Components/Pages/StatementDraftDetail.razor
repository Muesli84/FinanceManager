@page "/statement-drafts/{Id:guid}"
@rendermode InteractiveServer
@inject HttpClient Http
@inject NavigationManager Nav
@using FinanceManager.Application.Statements
@using FinanceManager.Domain.Statements
@using FinanceManager.Shared.Dtos
@using Microsoft.Extensions.Localization
@using FinanceManager.Web.Components.Shared
@inject IStringLocalizer<Components.Pages.StatementDraftDetail> Localizer

@code {
    [Parameter] public Guid Id { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? Src { get; set; } // "entry" when opened from entry detail
    [Parameter, SupplyParameterFromQuery] public Guid? FromEntryDraftId { get; set; }
    [Parameter, SupplyParameterFromQuery] public Guid? FromEntryId { get; set; }
    private StatementDraftDto? _draft;
    private EntryForm _form = new() { BookingDate = DateTime.Today };
    private List<AccountVm> _accounts = new();
    private List<ContactDto> _contacts = new();
    private Dictionary<string, List<AccountVm>> _groupedAccounts = new();
    private Guid? _selectedAccountId;
    private List<SavingsPlanDto> _savingsPlans = new();
    private bool _hasFile; private bool _showViewer; private string? _fileUrl;
    private DraftValidationResultDto? _validation; private bool _booking; private bool _pendingWarningConfirmation; private DraftValidationResultDto? _lastValidation; private string? _bookingError;

    // symbol mappings
    private readonly Dictionary<Guid, Guid?> _contactDisplaySymbolById = new();
    private readonly Dictionary<Guid, Guid?> _savingsPlanDisplaySymbolById = new();

    // Ribbon state
    private enum TabId { Statement }
    private List<Ribbon<TabId>.RibbonTab<TabId>> _tabs = new();
    private TabId _activeTab = TabId.Statement;

    private sealed record BookingResultDto(bool Success, bool HasWarnings, DraftValidationResultDto Validation, Guid? StatementImportId, int? TotalEntries, Guid? nextDraftId);

    protected override async Task OnParametersSetAsync()
    {
        _draft = await Http.GetFromJsonAsync<StatementDraftDto>($"/api/statement-drafts/{Id}");
        _hasFile = _draft != null; // always true for existing drafts; actual file may be missing but controller handles 404
        await LoadAccountsAsync();
        _selectedAccountId = _draft?.DetectedAccountId;
        await LoadSavingsPlansAsync();
        await LoadCategorySymbolMappingsAsync();
        if (_showViewer && _hasFile)
        {
            _fileUrl = $"/api/statement-drafts/{Id}/file";
        }
        BuildRibbon();
    }

    private async Task LoadCategorySymbolMappingsAsync()
    {
        _contactDisplaySymbolById.Clear();
        _savingsPlanDisplaySymbolById.Clear();

        // load contact categories
        var contactCategoryMap = new Dictionary<Guid, Guid?>();
        try
        {
            var creq = await Http.GetAsync("/api/contact-categories");
            if (creq.IsSuccessStatusCode)
            {
                var clist = await creq.Content.ReadFromJsonAsync<List<ContactCategoryDto>>() ?? new();
                foreach (var c in clist)
                {
                    contactCategoryMap[c.Id] = c.SymbolAttachmentId;
                }
            }
        }
        catch { }

        // load savings plan categories
        var savingsPlanCategoryMap = new Dictionary<Guid, Guid?>();
        try
        {
            var sreq = await Http.GetAsync("/api/savings-plan-categories");
            if (sreq.IsSuccessStatusCode)
            {
                var slist = await sreq.Content.ReadFromJsonAsync<List<SavingsPlanCategoryDto>>() ?? new();
                foreach (var s in slist)
                {
                    savingsPlanCategoryMap[s.Id] = s.SymbolAttachmentId;
                }
            }
        }
        catch { }

        // build contact display symbols (contact symbol or category fallback)
        foreach (var c in _contacts)
        {
            Guid? display = null;
            if (c.SymbolAttachmentId.HasValue) display = c.SymbolAttachmentId;
            else if (c.CategoryId.HasValue && contactCategoryMap.TryGetValue(c.CategoryId.Value, out var catSym) && catSym.HasValue) display = catSym;
            _contactDisplaySymbolById[c.Id] = display;
        }

        // build savings plan display symbols
        foreach (var p in _savingsPlans)
        {
            Guid? display = null;
            if (p.SymbolAttachmentId.HasValue) display = p.SymbolAttachmentId;
            else if (p.CategoryId.HasValue && savingsPlanCategoryMap.TryGetValue(p.CategoryId.Value, out var catSym) && catSym.HasValue) display = catSym;
            _savingsPlanDisplaySymbolById[p.Id] = display;
        }
    }

    private Guid? GetContactDisplaySymbol(Guid contactId)
        => _contactDisplaySymbolById.TryGetValue(contactId, out var v) ? v : null;

    private Guid? GetSavingsPlanDisplaySymbol(Guid planId)
        => _savingsPlanDisplaySymbolById.TryGetValue(planId, out var v) ? v : null;

    private void BuildRibbon()
    {
        var navItems = new List<Ribbon<TabId>.RibbonItem>();
        if (HasEntryContext)
        {
            navItems.Add(new Ribbon<TabId>.RibbonItem
            {
                Label = Localizer["Ribbon_BackToEntry"],
                IconSvg = "<svg><use href='/icons/sprite.svg#arrow-left'/></svg>",
                Size = Ribbon<TabId>.RibbonItemSize.Large,
                Callback = () => { BackToSourceEntry(); return Task.CompletedTask; }
            });
        }
        navItems.Add(new Ribbon<TabId>.RibbonItem
        {
            Label = Localizer["Ribbon_BackToOverview"],
            IconSvg = "<svg><use href='/icons/sprite.svg#arrow-left'/></svg>",
            Size = Ribbon<TabId>.RibbonItemSize.Large,
            Callback = () => { BackGeneric(); return Task.CompletedTask; }
        });

        navItems.Add(new Ribbon<TabId>.RibbonItem
        {
            Label = Localizer["Ribbon_Prev"],
            IconSvg = "<svg><use href='/icons/sprite.svg#chevron-left'/></svg>",
            Disabled = _draft?.PrevInUpload == null,
            Size = Ribbon<TabId>.RibbonItemSize.Large,
            Callback = () => { GoPrevInUpload(); return Task.CompletedTask; }
        });
        navItems.Add(new Ribbon<TabId>.RibbonItem
        {
            Label = Localizer["Ribbon_Next"],
            IconSvg = "<svg><use href='/icons/sprite.svg#chevron-right'/></svg>",
            Disabled = _draft?.NextInUpload == null,
            Size = Ribbon<TabId>.RibbonItemSize.Large,
            Callback = () => { GoNextInUpload(); return Task.CompletedTask; }
        });

        var navGroup = new Ribbon<TabId>.RibbonGroup
        {
            Title = Localizer["Ribbon_Group_Navigation"],
            Items = navItems
        };

        var manageItems = new List<Ribbon<TabId>.RibbonItem>
        {
            new()
            {
                Label = Localizer["Ribbon_Delete"],
                IconSvg = "<svg><use href='/icons/sprite.svg#delete'/></svg>",
                Size = Ribbon<TabId>.RibbonItemSize.Small,
                Callback = () => { DeleteDraftAsync(); return Task.CompletedTask; }
            },
            new()
            {
                Label = Localizer["Ribbon_Reclassify"],
                IconSvg = "<svg><use href='/icons/sprite.svg#refresh'/></svg>",
                Size = Ribbon<TabId>.RibbonItemSize.Small,
                Callback = () => { _ = ClassifyAsync(); return Task.CompletedTask; }
            },
            new()
            {
                Label = Localizer["Ribbon_Validate"],
                IconSvg = "<svg><use href='/icons/sprite.svg#check'/></svg>",
                Size = Ribbon<TabId>.RibbonItemSize.Small,
                Callback = async () => { await ValidateDraft(); }
            }
        };


        if (_draft != null && _draft.Status == FinanceManager.Domain.StatementDraftStatus.Draft)
        {
            manageItems.Insert(0, new Ribbon<TabId>.RibbonItem
            {
                Label = Localizer["Ribbon_Book"],
                IconSvg = "<svg><use href='/icons/sprite.svg#save'/></svg>",
                Size = Ribbon<TabId>.RibbonItemSize.Large,
                Disabled = _booking || _draft.Entries.Count == 0 || _draft.DetectedAccountId == null || _pendingWarningConfirmation,
                Callback = () => { _ = BookDraft(); return Task.CompletedTask; }
            });
        }

        // New: account details action - opens the detected account's detail page
        var refItems = new List<Ribbon<TabId>.RibbonItem>();
        refItems.Add(new Ribbon<TabId>.RibbonItem
        {
            Label = Localizer["Ribbon_AccountDetails"],
            IconSvg = "<svg><use href='/icons/sprite.svg#account'/></svg>",
            Disabled = _draft?.DetectedAccountId == null,
            Size = Ribbon<TabId>.RibbonItemSize.Large,
            Callback = () =>
            {
                var accId = _draft?.DetectedAccountId;
                if (accId != null)
                {
                    Nav.NavigateTo($"/accounts/{accId}");
                }
                return Task.CompletedTask;
            }
        });


        var manageGroup = new Ribbon<TabId>.RibbonGroup
        {
            Title = Localizer["Ribbon_Group_Manage"],
            Items = manageItems
        };

        var fileGroup = new Ribbon<TabId>.RibbonGroup
        {
            Title = Localizer["Ribbon_Group_Statement"],
            Items = new()
            {
                new Ribbon<TabId>.RibbonItem
                {
                    Label = _showViewer ? Localizer["Ribbon_HideOriginal"] : Localizer["Ribbon_ShowOriginal"],
                    IconSvg = "<svg><use href='/icons/sprite.svg#external'/></svg>",
                    Disabled = !_hasFile,
                    Size = Ribbon<TabId>.RibbonItemSize.Small,
                    Callback = () => { ToggleViewer(); BuildRibbon(); return Task.CompletedTask; }
                },
                new Ribbon<TabId>.RibbonItem
                {
                    Label = Localizer["Ribbon_Download"],
                    IconSvg = "<svg><use href='/icons/sprite.svg#save'/></svg>",
                    Disabled = !_hasFile,
                    Size = Ribbon<TabId>.RibbonItemSize.Small,
                    Callback = () => { DownloadFile(); return Task.CompletedTask; }
                }
            }
        };

        var refGroup =  new Ribbon<TabId>.RibbonGroup
        {
            Title = Localizer["Ribbon_Group_Related"],
            Items = refItems
        };

        _tabs = new()
        {
            new Ribbon<TabId>.RibbonTab<TabId>
            {
                Id = TabId.Statement,
                Title = Localizer["Ribbon_Tab_Statement"],
                Groups = new() { navGroup, manageGroup, fileGroup, refGroup }
            }
        };
    }

    private Task OnActiveTabChanged(TabId id)
    {
        _activeTab = id;
        return Task.CompletedTask;
    }

    private void GoPrevInUpload()
    {
        if (_draft?.PrevInUpload != null)
        {
            var qp = BuildContextQuery();
            Nav.NavigateTo($"/statement-drafts/{_draft.PrevInUpload}{qp}");
        }
    }
    private void GoNextInUpload()
    {
        if (_draft?.NextInUpload != null)
        {
            var qp = BuildContextQuery();
            Nav.NavigateTo($"/statement-drafts/{_draft.NextInUpload}{qp}");
        }
    }

    private string BuildContextQuery()
    {
        if (!string.Equals(Src, "entry", StringComparison.OrdinalIgnoreCase) || !FromEntryDraftId.HasValue || !FromEntryId.HasValue)
        {
            return string.Empty;
        }
        return $"?src=entry&fromEntryDraftId={FromEntryDraftId}&fromEntryId={FromEntryId}";
    }

    private async Task ValidateDraft()
    {
        try
        {
            _validation = await Http.GetFromJsonAsync<DraftValidationResultDto>($"/api/statement-drafts/{Id}/validate");
        }
        catch (Exception ex)
        {
            _bookingError = ex.Message;
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task BookDraft()
    {
        _bookingError = null; _pendingWarningConfirmation = false; _lastValidation = null; _booking = true;
        try
        {
            var resp = await Http.PostAsync($"/api/statement-drafts/{Id}/book", null);
            if (resp.StatusCode == System.Net.HttpStatusCode.PreconditionRequired)
            {
                var res = await resp.Content.ReadFromJsonAsync<BookingResultDto>();
                _lastValidation = res?.Validation;
                _validation = res?.Validation;
                _pendingWarningConfirmation = true;
            }
            else if (!resp.IsSuccessStatusCode)
            {
                BookingResultDto? resObj = null;
                try { resObj = await resp.Content.ReadFromJsonAsync<BookingResultDto>(); } catch { }
                if (resObj?.Validation != null)
                {
                    _validation = resObj.Validation;
                    _bookingError = Localizer["Error_FixIssues"];
                }
                else
                {
                    _bookingError = await resp.Content.ReadAsStringAsync();
                }
            }
            else
            {
                var ok = await resp.Content.ReadFromJsonAsync<BookingResultDto>();
                if (ok != null && ok.Success)
                {
                    if (ok.nextDraftId is not null)
                    {
                        Nav.NavigateTo($"/statement-drafts/{ok.nextDraftId}", true);
                        return;
                    }
                    Nav.NavigateTo("/statement-drafts", true);
                    return;
                }
            }
        }
        finally
        {
            _booking = false;
            BuildRibbon();
            StateHasChanged();
        }
    }

    private async Task ForceBook()
    {
        _booking = true; _bookingError = null;
        try
        {
            var resp = await Http.PostAsync($"/api/statement-drafts/{Id}/book?forceWarnings=true", null);
            if (!resp.IsSuccessStatusCode)
            {
                BookingResultDto? resObj = null; try { resObj = await resp.Content.ReadFromJsonAsync<BookingResultDto>(); } catch { }
                if (resObj?.Validation != null) { _validation = resObj.Validation; _bookingError = Localizer["Error_FixIssues"]; }
                else { _bookingError = await resp.Content.ReadAsStringAsync(); }
            }
            else
            {
                var ok = await resp.Content.ReadFromJsonAsync<BookingResultDto>();
                if (ok != null && ok.Success)
                {
                    if (ok.nextDraftId is not null) Nav.NavigateTo($"/statement-drafts/{ok.nextDraftId}", true); else Nav.NavigateTo("/statement-drafts", true);
                }
            }
        }
        finally { _booking = false; _pendingWarningConfirmation = false; }
        BuildRibbon();
    }

    private async Task LoadAccountsAsync()
    {
        var resp = await Http.GetAsync("/api/accounts?skip=0&take=500");
        if (resp.IsSuccessStatusCode)
        {
            var list = await resp.Content.ReadFromJsonAsync<List<AccountDto>>() ?? new();
            _accounts = list.Select(a => new AccountVm { Id = a.Id, Name = a.Name, BankContactId = a.BankContactId }).ToList();
            var contactsResp = await Http.GetAsync("/api/contacts?skip=0&take=500");
            _contacts = contactsResp.IsSuccessStatusCode ? await contactsResp.Content.ReadFromJsonAsync<List<ContactDto>>() ?? new() : new();
            var bankContacts = _contacts.Where(c => c.Type == ContactType.Bank).ToDictionary(c => c.Id, c => c.Name);
            _groupedAccounts = _accounts.GroupBy(a => bankContacts.TryGetValue(a.BankContactId, out var n) ? n : "(Bank)").OrderBy(g => g.Key).ToDictionary(g => g.Key, g => g.OrderBy(x => x.Name).ToList());
        }
    }

    private async Task LoadSavingsPlansAsync()
    {
        var resp = await Http.GetAsync("/api/savings-plans?onlyActive=true");
        if (resp.IsSuccessStatusCode) { _savingsPlans = await resp.Content.ReadFromJsonAsync<List<SavingsPlanDto>>() ?? new(); }
    }

    private async Task OnAccountChanged(ChangeEventArgs e)
    {
        if (Guid.TryParse(e.Value?.ToString(), out var accId))
        {
            var resp = await Http.PostAsync($"/api/statement-drafts/{Id}/account/{accId}", null);
            if (resp.IsSuccessStatusCode)
            {
                _draft = await resp.Content.ReadFromJsonAsync<StatementDraftDto>();
                _selectedAccountId = _draft?.DetectedAccountId;
                BuildRibbon();
                StateHasChanged();
            }
        }
    }

    private async Task AddEntryAsync()
    {
        var response = await Http.PostAsJsonAsync($"/api/statement-drafts/{Id}/entries", new { BookingDate = _form.BookingDate, Amount = _form.Amount, Subject = _form.Subject });
        if (response.IsSuccessStatusCode)
        {
            _draft = await response.Content.ReadFromJsonAsync<StatementDraftDto>();
            _form = new EntryForm { BookingDate = DateTime.Today };
            BuildRibbon();
            StateHasChanged();
        }
    }

    private async Task ClassifyAsync()
    {
        var response = await Http.PostAsync($"/api/statement-drafts/{Id}/classify", null);
        if (response.IsSuccessStatusCode)
        {
            _draft = await response.Content.ReadFromJsonAsync<StatementDraftDto>();
            _selectedAccountId = _draft?.DetectedAccountId;
            BuildRibbon();
            StateHasChanged();
        }
    }

    private async Task DeleteDraftAsync()
    {
        if (_draft == null) { return; }
        var resp = await Http.DeleteAsync($"/api/statement-drafts/{Id}");
        if (resp.IsSuccessStatusCode || resp.StatusCode == System.Net.HttpStatusCode.NoContent) { Nav.NavigateTo("/statement-drafts"); }
        else { _bookingError = await resp.Content.ReadAsStringAsync(); StateHasChanged(); }
    }

    private bool HasEntryContext => string.Equals(Src, "entry", StringComparison.OrdinalIgnoreCase) && FromEntryDraftId.HasValue && FromEntryId.HasValue;

    private void OpenEntry(Guid entryId)
    {
        string url;
        if (HasEntryContext)
        {
            var existing = BuildContextQuery();
            url = $"/statement-drafts/{Id}/entries/{entryId}{existing}";
        }
        else
        {
            url = $"/statement-drafts/{Id}/entries/{entryId}?src=entry&fromEntryDraftId={Id}&fromEntryId={entryId}";
        }
        Nav.NavigateTo(url);
    }
    private void BackToParent()
    {
        if (_draft?.ParentDraftId != null && _draft.ParentEntryId != null)
        {
            var qp = BuildContextQuery();
            Nav.NavigateTo($"/statement-drafts/{_draft.ParentDraftId}/entries/{_draft.ParentEntryId}{qp}");
        }
    }
    private void ToggleViewer() { if (!_hasFile) { return; } _showViewer = !_showViewer; _fileUrl = _showViewer ? $"/api/statement-drafts/{Id}/file" : null; StateHasChanged(); }
    private void DownloadFile() { if (!_hasFile) { return; } Nav.NavigateTo($"/api/statement-drafts/{Id}/file", forceLoad:true); }

    private void BackGeneric()
    {
        Nav.NavigateTo("/statement-drafts");
    }

    private void BackToSourceEntry()
    {
        if (HasEntryContext)
        {
            Nav.NavigateTo($"/statement-drafts/{FromEntryDraftId}/entries/{FromEntryId}");
        }
    }

    private sealed class EntryForm { public DateTime BookingDate { get; set; } public decimal Amount { get; set; } public string Subject { get; set; } = string.Empty; }

    private sealed record StatementDraftEntryDto(Guid Id, DateTime BookingDate, DateTime? ValutaDate, decimal Amount, string CurrencyCode, string Subject, string? RecipientName, string? BookingDescription, bool IsAnnounced, StatementDraftEntryStatus Status, Guid? ContactId, Guid? SavingsPlanId, Guid? SplitDraftId);
    private sealed record StatementDraftDto(Guid DraftId, string OriginalFileName, Guid? DetectedAccountId, FinanceManager.Domain.StatementDraftStatus Status, List<StatementDraftEntryDto> Entries, decimal TotalAmount, bool IsSplitDraft, Guid? ParentDraftId, Guid? ParentEntryId, decimal? ParentEntryAmount, Guid? UploadGroupId, Guid? PrevInUpload, Guid? NextInUpload);
    private sealed record DraftValidationMessageDto(string Code, string Severity, string Message, Guid DraftId, Guid? EntryId);
    private sealed record DraftValidationResultDto(Guid DraftId, bool IsValid, IReadOnlyList<DraftValidationMessageDto> Messages);
    private sealed record AccountDto(Guid Id, string Name, int Type, string? Iban, decimal CurrentBalance, Guid BankContactId);
    private sealed record ContactDto(Guid Id, string Name, ContactType Type, Guid? CategoryId, Guid? SymbolAttachmentId);
    private enum ContactType { Self, Bank, Person, Organization, Other }
    private sealed record SavingsPlanDto(Guid Id, string Name, SavingsPlanType? Type = null, decimal? TargetAmount = null, DateTime? TargetDate = null, SavingsPlanInterval? Interval = null, bool IsActive = true, DateTime? CreatedUtc = null, DateTime? ArchivedUtc = null, Guid? CategoryId = null, string? ContractNumber = null, Guid? SymbolAttachmentId = null);
    private sealed class AccountVm { public Guid Id { get; set; } public string Name { get; set; } = string.Empty; public Guid BankContactId { get; set; } }
}

<Ribbon TTabEnum="StatementDraftDetail.TabId" Tabs="_tabs" ActiveTab="_activeTab" ActiveTabChanged="OnActiveTabChanged" />

<h3>@Localizer["Title"]</h3>
@if (_draft == null)
{
    <p>@Localizer["Loading"]</p>
}
else
{
    @if(!string.IsNullOrEmpty(_bookingError))
    {
        <div style="margin:.5rem 0;color:#e66;font-size:.75rem;">@_bookingError</div>
    }
    @if(_pendingWarningConfirmation && _lastValidation != null)
    {
        <div style="margin:.75rem 0;padding:.6rem .8rem;border:1px solid #665500;background:#221e00;font-size:.7rem;max-width:960px;">
            <strong>@_lastValidation.Messages.Count(m=>m.Severity=="Warning") @Localizer["WarningsFound"]</strong> @Localizer["ProceedAnywayQuestion"]
            <div style="margin-top:.5rem;display:flex;gap:.5rem;">
                <button class="icon-btn" @onclick="ForceBook">@Localizer["Yes"]</button>
                <button class="icon-btn" @onclick="(()=>{_pendingWarningConfirmation=false;})">@Localizer["Cancel"]</button>
            </div>
        </div>
    }
    <p><strong>@Localizer["File"]:</strong> @_draft.OriginalFileName</p>
    <p><strong>@Localizer["Status"]:</strong> @_draft.Status</p>
    <p>
        <strong>@Localizer["Account"]:</strong> 
        <select @onchange="OnAccountChanged" value="@_selectedAccountId">
            <option value="">-- @Localizer["Select"] --</option>
            @foreach (var grp in _groupedAccounts)
            {
                <optgroup label="@grp.Key">
                    @foreach (var acc in grp.Value)
                    {
                        <option value="@acc.Id" selected="@(acc.Id == _selectedAccountId)">@acc.Name</option>
                    }
                </optgroup>
            }
        </select>
    </p>

    @if(_validation != null)
    {
        var globalMessages = _validation.Messages.Where(m=>m.EntryId==null || m.DraftId != Id).ToList();
        if(globalMessages.Any())
        {
            <div style="margin:.5rem 0 1rem 0;padding:.6rem .75rem;border:1px solid #444;border-radius:4px;background:#181818;max-width:960px;">
                <h4 style="margin:0.1rem 0 .4rem 0;font-size:.75rem;">@Localizer["GlobalMessages"]</h4>
                <ul style="margin:0;padding-left:1.1rem;font-size:.65rem;">
                    @foreach(var gm in globalMessages)
                    {
                        var c = gm.Severity=="Error"?"#e66":"#cc6";
                        <li style="margin:.2rem 0;color:@c;">@gm.Message</li>
                    }
                </ul>
            </div>
        }
    }

    <p><strong>@Localizer["TotalAmount"]:</strong> @_draft.Entries.Sum(e => e.Amount)</p>
    @if (_draft.ParentEntryAmount != null)
    {
        <p style="color:#ccc;"><strong>@Localizer["ParentEntryAmount"]:</strong> @_draft.ParentEntryAmount</p>
    }

    <h4>@Localizer["EntriesHeader"] (@_draft.Entries.Count)</h4>
    <div class="draft-entries-container">
        <table class="fm-table wide">
            <thead>
                <tr>
                    <th style="width:1.4rem;"></th>
                    <th style="width:7rem;">@Localizer["Th_Date"]</th>
                    <th style="width:7rem;">@Localizer["Th_Valuta"]</th>
                    <th style="width:7rem;text-align:right;">@Localizer["Th_Amount"]</th>
                    <th style="width:6rem;">@Localizer["Th_Currency"]</th>
                    <th>@Localizer["Th_Subject"]</th>
                    <th style="width:14%;">@Localizer["Th_Recipient"]</th>
                    <th style="width:12%;">@Localizer["Th_SavingsPlan"]</th>
                    <th>@Localizer["Th_Description"]</th>
                    <th style="width:6rem;">@Localizer["Th_Announced"]</th>
                    <th style="width:9rem;">@Localizer["Th_Status"]</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var e in _draft.Entries
                    .OrderBy(e => e.Status == StatementDraftEntryStatus.AlreadyBooked)
                    .ThenBy(e => e.BookingDate))
                {
                    var entryMessages = _validation?.Messages.Where(m => m.EntryId == e.Id).ToList() ?? new();
                    var entryErrors = entryMessages.Count(m=>m.Severity=="Error");
                    var entryWarnings = entryMessages.Count(m=>m.Severity=="Warning");
                    var rowStyle = e.Status == StatementDraftEntryStatus.AlreadyBooked
                        ? "opacity:.55;background:#141414;"
                        : e.Status == StatementDraftEntryStatus.Announced 
                        ? "opacity:.55;background:#131313;"
                        : string.Empty;
                    <tr style="cursor:pointer;@rowStyle" @onclick="(() => OpenEntry(e.Id))">
                        <td>
                            @if (e.SplitDraftId != null)
                            {
                                <svg title='@Localizer["LinkedSplitDraft"]' aria-label="Split" style="width:1rem;height:1rem;">
                                    <use href="/icons/sprite.svg#link" />
                                </svg>
                            }
                        </td>
                        <td>@e.BookingDate.ToShortDateString()</td>
                        <td>@(e.ValutaDate?.ToShortDateString() ?? "")</td>
                        <td style="text-align:right;">@e.Amount</td>
                        <td>@e.CurrencyCode</td>
                        <td class="wrap">@e.Subject</td>
                        <td class="wrap">
                            @if (e.ContactId != null)
                            {
                                var contact = _contacts.FirstOrDefault(a => a.Id == e.ContactId);
                                <div style="display:flex;gap:.5rem;align-items:center;">
                                    @{
                                        var symbolId = contact != null ? GetContactDisplaySymbol(contact.Id) : null;
                                    }
                                    @if (symbolId != null)
                                    {
                                        <div style="width:28px;height:28px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;border-radius:6px;">
                                            <img src="@($"/api/attachments/{symbolId}/download")" alt="symbol" style="max-width:100%;max-height:100%;display:block;" />
                                        </div>
                                    }
                                    else
                                    {
                                        <div style="width:28px;height:28px;border-radius:6px;border:1px dashed var(--border);display:flex;align-items:center;justify-content:center;color:var(--muted);">
                                            <svg style="width:18px;height:18px;opacity:.6;"><use href="/icons/sprite.svg#image" /></svg>
                                        </div>
                                    }
                                    <span>@contact?.Name</span>
                                </div>
                            }
                            else
                            {
                                <span>@(string.IsNullOrWhiteSpace(e.RecipientName) ? "" : e.RecipientName)</span>
                            }
                        </td>
                        <td>
                            @if (e.SavingsPlanId != null)
                            {
                                var plan = _savingsPlans.FirstOrDefault(p => p.Id == e.SavingsPlanId);
                                <div style="display:flex;gap:.5rem;align-items:center;">
                                    @{
                                        var sId = plan != null ? GetSavingsPlanDisplaySymbol(plan.Id) : null;
                                    }
                                    @if (sId != null)
                                    {
                                        <div style="width:28px;height:28px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;border-radius:6px;">
                                            <img src="@($"/api/attachments/{sId}/download")" alt="symbol" style="max-width:100%;max-height:100%;display:block;" />
                                        </div>
                                    }
                                    else
                                    {
                                        <div style="width:28px;height:28px;border-radius:6px;border:1px dashed var(--border);display:flex;align-items:center;justify-content:center;color:var(--muted);">
                                            <svg style="width:18px;height:18px;opacity:.6;"><use href="/icons/sprite.svg#image" /></svg>
                                        </div>
                                    }
                                    <span>@plan?.Name</span>
                                </div>
                            }
                            else
                            {
                                <span></span>
                            }
                        </td>
                        <td class="wrap">@(string.IsNullOrWhiteSpace(e.BookingDescription) ? "" : e.BookingDescription)</td>
                        <td>@(e.IsAnnounced ? "✓" : "")</td>
                        <td>@e.Status</td>
                    </tr>
                    @if(entryMessages.Any())
                    {
                        <tr class="validation-row" style="background:#181818;@rowStyle">
                            <td colspan="11" style="padding:.4rem .75rem;">
                                <div style="display:flex;gap:1rem;flex-wrap:wrap;align-items:flex-start;">
                                    <div style="display:flex;gap:.6rem;font-size:.65rem;">
                                        @if(entryErrors>0){<span style="color:#e66;">@Localizer["Errors"]: @entryErrors</span>}
                                        @if(entryWarnings>0){<span style="color:#cc6;">@Localizer["Warnings"]: @entryWarnings</span>}
                                    </div>
                                    <ul style="margin:0;padding-left:1rem;flex:1;list-style:disc;">
                                        @foreach(var m in entryMessages)
                                        {
                                            var c = m.Severity=="Error"?"#e66":"#cc6";
                                            <li style="margin:.2rem 0;color:@c;font-size:.65rem;">@m.Message</li>
                                        }
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @if (_draft.Status == FinanceManager.Domain.StatementDraftStatus.Draft)
    {
        <h4>@Localizer["AddEntryHeader"]</h4>
        <EditForm Model="_form" OnValidSubmit="AddEntryAsync">
            <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;">
                <InputDate @bind-Value="_form.BookingDate" />
                <InputNumber @bind-Value="_form.Amount" />
                <InputText @bind-Value="_form.Subject" />
                <button type="submit" class="icon-btn">@Localizer["Btn_Add"]</button>
            </div>
        </EditForm>
    }
}

<div style="display:flex;align-items:flex-start;gap:1rem;">
    <div style="flex:1;min-width:0;">
    </div>
    @if (_showViewer && _hasFile)
    {
        <div style="width:420px;max-width:45%;height:70vh;position:sticky;top:1rem;border:1px solid var(--border);border-radius:var(--radius);background:#111;display:flex;flex-direction:column;">
            <div style="padding:.35rem .6rem;font-size:.7rem;letter-spacing:.05em;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
                <span>@Localizer["OriginalFileTitle"]</span>
                <button class="icon-btn" style="padding:.25rem .4rem;" @onclick="ToggleViewer" title='@Localizer["Btn_Close"]' aria-label='@Localizer["Btn_Close"]'><svg><use href="/icons/sprite.svg#clear" /></svg></button>
            </div>
            <iframe src="@_fileUrl" style="flex:1;border:0;width:100%;"></iframe>
        </div>
    }
</div>

<style>
/* Subtle visual separation for already booked items when table has its own background */
.fm-table tr[style*="opacity:.55"] td {
    color: #aaa;
}
</style>
