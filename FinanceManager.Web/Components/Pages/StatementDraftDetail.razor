@page "/statement-drafts/{Id:guid}"
@rendermode InteractiveServer
@inject NavigationManager Nav
@inject FinanceManager.Shared.IApiClient Api
@using FinanceManager.Application.Statements
@using FinanceManager.Domain.Statements
@using FinanceManager.Shared.Dtos
@using FinanceManager.Shared.Dtos.Statements
@using FinanceManager.Shared.Dtos.SavingsPlans
@using FinanceManager.Shared.Dtos.Accounts
@using FinanceManager.Shared.Dtos.Contacts
@using FinanceManager.Web.Components.Shared
@using Microsoft.Extensions.Localization
@using FinanceManager.Domain.Contacts
@inject IStringLocalizer<Components.Pages.StatementDraftDetail> Localizer

@code {
    [Parameter] public Guid Id { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? Src { get; set; }
    [Parameter, SupplyParameterFromQuery] public Guid? FromEntryDraftId { get; set; }
    [Parameter, SupplyParameterFromQuery] public Guid? FromEntryId { get; set; }
    private StatementDraftDetailDto? _draft;
    private EntryForm _form = new() { BookingDate = DateTime.Today };
    private List<AccountVm> _accounts = new();
    private List<ContactDto> _contacts = new();
    private Dictionary<string, List<AccountVm>> _groupedAccounts = new();
    private Guid? _selectedAccountId;
    private List<SavingsPlanDto> _savingsPlans = new();
    private bool _hasFile; private bool _showViewer; private string? _fileUrl;
    private DraftValidationResultDto? _validation; private bool _booking; private bool _pendingWarningConfirmation; private DraftValidationResultDto? _lastValidation; private string? _bookingError;

    private readonly Dictionary<Guid, Guid?> _contactDisplaySymbolById = new();
    private readonly Dictionary<Guid, Guid?> _savingsPlanDisplaySymbolById = new();

    private enum TabId { Statement }
    private List<Ribbon<TabId>.RibbonTab<TabId>> _tabs = new();
    private TabId _activeTab = TabId.Statement;

    protected override async Task OnParametersSetAsync()
    {
        _draft = await Api.StatementDrafts_GetAsync(Id);
        _hasFile = _draft != null;
        await LoadAccountsAsync();
        _selectedAccountId = _draft?.DetectedAccountId;
        await LoadSavingsPlansAsync();
        await LoadCategorySymbolMappingsAsync();
        if (_showViewer && _hasFile)
        {
            _fileUrl = $"/api/statement-drafts/{Id}/file";
        }
        BuildRibbon();
    }

    private async Task LoadCategorySymbolMappingsAsync()
    {
        _contactDisplaySymbolById.Clear();
        _savingsPlanDisplaySymbolById.Clear();
        var contactCategoryMap = new Dictionary<Guid, Guid?>();
        try
        {
            var clist = await Api.ContactCategories_ListAsync();
            foreach (var c in clist)
            {
                contactCategoryMap[c.Id] = c.SymbolAttachmentId;
            }
        }
        catch { }
        var savingsPlanCategoryMap = new Dictionary<Guid, Guid?>();
        try
        {
            var slist = await Api.SavingsPlanCategories_ListAsync();
            foreach (var s in slist)
            {
                savingsPlanCategoryMap[s.Id] = s.SymbolAttachmentId;
            }
        }
        catch { }
        foreach (var c in _contacts)
        {
            Guid? display = null;
            if (c.SymbolAttachmentId.HasValue) display = c.SymbolAttachmentId;
            else if (c.CategoryId.HasValue && contactCategoryMap.TryGetValue(c.CategoryId.Value, out var catSym) && catSym.HasValue) display = catSym;
            _contactDisplaySymbolById[c.Id] = display;
        }
        foreach (var p in _savingsPlans)
        {
            Guid? display = null;
            if (p.SymbolAttachmentId.HasValue) display = p.SymbolAttachmentId;
            else if (p.CategoryId.HasValue && savingsPlanCategoryMap.TryGetValue(p.CategoryId.Value, out var catSym) && catSym.HasValue) display = catSym;
            _savingsPlanDisplaySymbolById[p.Id] = display;
        }
    }

    private Guid? GetContactDisplaySymbol(Guid contactId) => _contactDisplaySymbolById.TryGetValue(contactId, out var v) ? v : null;
    private Guid? GetSavingsPlanDisplaySymbol(Guid planId) => _savingsPlanDisplaySymbolById.TryGetValue(planId, out var v) ? v : null;

    private void BuildRibbon()
    {
        var navItems = new List<Ribbon<TabId>.RibbonItem>();
        if (HasEntryContext)
        {
            navItems.Add(new Ribbon<TabId>.RibbonItem
            {
                Label = Localizer["Ribbon_BackToEntry"],
                IconSvg = "<svg><use href='/icons/sprite.svg#arrow-left'/></svg>",
                Size = Ribbon<TabId>.RibbonItemSize.Large,
                Callback = () => { BackToSourceEntry(); return Task.CompletedTask; }
            });
        }
        navItems.Add(new Ribbon<TabId>.RibbonItem
        {
            Label = Localizer["Ribbon_BackToOverview"],
            IconSvg = "<svg><use href='/icons/sprite.svg#arrow-left'/></svg>",
            Size = Ribbon<TabId>.RibbonItemSize.Large,
            Callback = () => { BackGeneric(); return Task.CompletedTask; }
        });
        navItems.Add(new Ribbon<TabId>.RibbonItem
        {
            Label = Localizer["Ribbon_Prev"],
            IconSvg = "<svg><use href='/icons/sprite.svg#chevron-left'/></svg>",
            Disabled = _draft?.PrevInUpload == null,
            Size = Ribbon<TabId>.RibbonItemSize.Large,
            Callback = () => { GoPrevInUpload(); return Task.CompletedTask; }
        });
        navItems.Add(new Ribbon<TabId>.RibbonItem
        {
            Label = Localizer["Ribbon_Next"],
            IconSvg = "<svg><use href='/icons/sprite.svg#chevron-right'/></svg>",
            Disabled = _draft?.NextInUpload == null,
            Size = Ribbon<TabId>.RibbonItemSize.Large,
            Callback = () => { GoNextInUpload(); return Task.CompletedTask; }
        });
        var navGroup = new Ribbon<TabId>.RibbonGroup { Title = Localizer["Ribbon_Group_Navigation"], Items = navItems };

        var manageItems = new List<Ribbon<TabId>.RibbonItem>
        {
            new()
            {
                Label = Localizer["Ribbon_Delete"],
                IconSvg = "<svg><use href='/icons/sprite.svg#delete'/></svg>",
                Size = Ribbon<TabId>.RibbonItemSize.Small,
                Callback = () => { DeleteDraftAsync(); return Task.CompletedTask; }
            },
            new()
            {
                Label = Localizer["Ribbon_Reclassify"],
                IconSvg = "<svg><use href='/icons/sprite.svg#refresh'/></svg>",
                Size = Ribbon<TabId>.RibbonItemSize.Small,
                Callback = () => { _ = ClassifyAsync(); return Task.CompletedTask; }
            },
            new()
            {
                Label = Localizer["Ribbon_Validate"],
                IconSvg = "<svg><use href='/icons/sprite.svg#check'/></svg>",
                Size = Ribbon<TabId>.RibbonItemSize.Small,
                Callback = async () => { await ValidateDraft(); }
            }
        };
        if (_draft != null && _draft.Status == StatementDraftStatus.Draft)
        {
            manageItems.Insert(0, new Ribbon<TabId>.RibbonItem
            {
                Label = Localizer["Ribbon_Book"],
                IconSvg = "<svg><use href='/icons/sprite.svg#save'/></svg>",
                Size = Ribbon<TabId>.RibbonItemSize.Large,
                Disabled = _booking || _draft.Entries.Count == 0 || _draft.DetectedAccountId == null || _pendingWarningConfirmation,
                Callback = () => { _ = BookDraft(); return Task.CompletedTask; }
            });
        }
        var refItems = new List<Ribbon<TabId>.RibbonItem>
        {
            new Ribbon<TabId>.RibbonItem
            {
                Label = Localizer["Ribbon_AccountDetails"],
                IconSvg = "<svg><use href='/icons/sprite.svg#account'/></svg>",
                Disabled = _draft?.DetectedAccountId == null,
                Size = Ribbon<TabId>.RibbonItemSize.Large,
                Callback = () => { var accId = _draft?.DetectedAccountId; if (accId != null) { Nav.NavigateTo($"/accounts/{accId}"); } return Task.CompletedTask; }
            }
        };
        var manageGroup = new Ribbon<TabId>.RibbonGroup { Title = Localizer["Ribbon_Group_Manage"], Items = manageItems };
        var fileGroup = new Ribbon<TabId>.RibbonGroup
        {
            Title = Localizer["Ribbon_Group_Statement"],
            Items = new()
            {
                new Ribbon<TabId>.RibbonItem
                {
                    Label = _showViewer ? Localizer["Ribbon_HideOriginal"] : Localizer["Ribbon_ShowOriginal"],
                    IconSvg = "<svg><use href='/icons/sprite.svg#external'/></svg>",
                    Disabled = !_hasFile,
                    Size = Ribbon<TabId>.RibbonItemSize.Small,
                    Callback = () => { ToggleViewer(); BuildRibbon(); return Task.CompletedTask; }
                },
                new Ribbon<TabId>.RibbonItem
                {
                    Label = Localizer["Ribbon_Download"],
                    IconSvg = "<svg><use href='/icons/sprite.svg#save'/></svg>",
                    Disabled = !_hasFile,
                    Size = Ribbon<TabId>.RibbonItemSize.Small,
                    Callback = () => { DownloadFile(); return Task.CompletedTask; }
                }
            }
        };
        var refGroup = new Ribbon<TabId>.RibbonGroup { Title = Localizer["Ribbon_Group_Related"], Items = refItems };
        _tabs = new()
        {
            new Ribbon<TabId>.RibbonTab<TabId>
            {
                Id = TabId.Statement,
                Title = Localizer["Ribbon_Tab_Statement"],
                Groups = new() { navGroup, manageGroup, fileGroup, refGroup }
            }
        };
    }

    private Task OnActiveTabChanged(TabId id) { _activeTab = id; return Task.CompletedTask; }
    private void GoPrevInUpload() { if (_draft?.PrevInUpload != null) { var qp = BuildContextQuery(); Nav.NavigateTo($"/statement-drafts/{_draft.PrevInUpload}{qp}"); } }
    private void GoNextInUpload() { if (_draft?.NextInUpload != null) { var qp = BuildContextQuery(); Nav.NavigateTo($"/statement-drafts/{_draft.NextInUpload}{qp}"); } }
    private string BuildContextQuery() => !string.Equals(Src, "entry", StringComparison.OrdinalIgnoreCase) || !FromEntryDraftId.HasValue || !FromEntryId.HasValue ? string.Empty : $"?src=entry&fromEntryDraftId={FromEntryDraftId}&fromEntryId={FromEntryId}";

    private async Task ValidateDraft()
    {
        try { _validation = await Api.StatementDrafts_ValidateAsync(Id); }
        catch (Exception ex) { _bookingError = ex.Message; }
        finally { StateHasChanged(); }
    }

    private async Task BookDraft()
    {
        _bookingError = null; _pendingWarningConfirmation = false; _lastValidation = null; _booking = true;
        try
        {
            var res = await Api.StatementDrafts_BookAsync(Id, forceWarnings: false);
            if (res != null && res.HasWarnings)
            {
                _lastValidation = res.Validation; _validation = res.Validation; _pendingWarningConfirmation = true;
            }
            else if (res?.Success != true)
            {
                if (res?.Validation != null) { _validation = res.Validation; _bookingError = Localizer["Error_FixIssues"]; }
                else { _bookingError = Api.LastError ?? Localizer["Error_Unknown"]; }
            }
            else
            {
                if (res.nextDraftId is not null) { Nav.NavigateTo($"/statement-drafts/{res.nextDraftId}", true); return; }
                Nav.NavigateTo("/statement-drafts", true); return;
            }
        }
        finally { _booking = false; BuildRibbon(); StateHasChanged(); }
    }

    private async Task ForceBook()
    {
        _booking = true; _bookingError = null;
        try
        {
            var res = await Api.StatementDrafts_BookAsync(Id, forceWarnings: true);
            if (res?.Success != true)
            {
                if (res?.Validation != null) { _validation = res.Validation; _bookingError = Localizer["Error_FixIssues"]; }
                else { _bookingError = Api.LastError ?? Localizer["Error_Unknown"]; }
            }
            else
            {
                if (res.nextDraftId is not null) Nav.NavigateTo($"/statement-drafts/{res.nextDraftId}", true); else Nav.NavigateTo("/statement-drafts", true);
            }
        }
        finally { _booking = false; _pendingWarningConfirmation = false; BuildRibbon(); }
    }

    private async Task LoadAccountsAsync()
    {
        var list = await Api.GetAccountsAsync(skip: 0, take: 500, bankContactId: null);
        _accounts = list.Select(a => new AccountVm { Id = a.Id, Name = a.Name, BankContactId = a.BankContactId }).ToList();
        var contacts = await Api.Contacts_ListAsync(skip: 0, take: 500, type: null, all: true, nameFilter: null);
        _contacts = contacts.ToList();
        var bankContacts = _contacts.Where(c => c.Type == ContactType.Bank).ToDictionary(c => c.Id, c => c.Name);
        _groupedAccounts = _accounts
            .GroupBy(a => bankContacts.TryGetValue(a.BankContactId, out var n) ? n : "(Bank)")
            .OrderBy(g => g.Key)
            .ToDictionary(g => g.Key, g => g.OrderBy(x => x.Name).ToList());
    }

    private async Task LoadSavingsPlansAsync()
    {
        try
        {
            var list = await Api.SavingsPlans_ListAsync(true);
            _savingsPlans = list.ToList();
        }
        catch
        {
            _savingsPlans = new();
        }
    }

    private async Task OnAccountChanged(ChangeEventArgs e)
    {
        if (Guid.TryParse(e.Value?.ToString(), out var accId))
        {
            var after = await Api.StatementDrafts_SetAccountAsync(Id, accId);
            if (after != null)
            {
                _draft = after;
                _selectedAccountId = _draft?.DetectedAccountId;
                BuildRibbon(); StateHasChanged();
            }
        }
    }

    private async Task ClassifyAsync()
    {
        var after = await Api.StatementDrafts_ClassifyAsync(Id);
        if (after != null)
        {
            _draft = after;
            _selectedAccountId = _draft?.DetectedAccountId; BuildRibbon(); StateHasChanged();
        }
    }

    private async Task DeleteDraftAsync()
    {
        if (_draft == null) { return; }
        var ok = await Api.StatementDrafts_DeleteAsync(Id);
        if (ok) { Nav.NavigateTo("/statement-drafts"); }
        else { _bookingError = Api.LastError ?? Localizer["Error_Unknown"]; StateHasChanged(); }
    }

    private sealed class EntryForm { public DateTime BookingDate { get; set; } public decimal Amount { get; set; } public string Subject { get; set; } = string.Empty; }
    private sealed class AccountVm { public Guid Id { get; set; } public string Name { get; set; } = string.Empty; public Guid BankContactId { get; set; } }

    private bool HasEntryContext => string.Equals(Src, "entry", StringComparison.OrdinalIgnoreCase) && FromEntryDraftId.HasValue && FromEntryId.HasValue;

    private void OpenEntry(Guid entryId)
    {
        var url = HasEntryContext ? $"/statement-drafts/{Id}/entries/{entryId}{BuildContextQuery()}" : $"/statement-drafts/{Id}/entries/{entryId}?src=entry&fromEntryDraftId={Id}&fromEntryId={entryId}";
        Nav.NavigateTo(url);
    }
    private void ToggleViewer() { if (!_hasFile) { return; } _showViewer = !_showViewer; _fileUrl = _showViewer ? $"/api/statement-drafts/{Id}/file" : null; StateHasChanged(); }
    private void DownloadFile() { if (!_hasFile) { return; } Nav.NavigateTo($"/statement-drafts/{Id}/file", forceLoad:true); }
    private void BackGeneric() { Nav.NavigateTo("/statement-drafts"); }
    private void BackToSourceEntry() { if (HasEntryContext) { Nav.NavigateTo($"/statement-drafts/{FromEntryDraftId}/entries/{FromEntryId}"); } }

    private async Task AddEntryAsync()
    {
        var after = await Api.StatementDrafts_AddEntryAsync(Id, new StatementDraftAddEntryRequest(_form.BookingDate, _form.Amount, _form.Subject));
        if (after != null)
        {
            _draft = after;
            _form = new EntryForm { BookingDate = DateTime.Today }; BuildRibbon(); StateHasChanged();
        }
    }
}

<Ribbon TTabEnum="StatementDraftDetail.TabId" Tabs="_tabs" ActiveTab="_activeTab" ActiveTabChanged="OnActiveTabChanged" />

<h3>@Localizer["Title"]</h3>
@if (_draft == null)
{
    <p>@Localizer["Loading"]</p>
}
else
{
    @if(!string.IsNullOrEmpty(_bookingError))
    { <div class="booking-error">@_bookingError</div> }
    @if(_pendingWarningConfirmation && _lastValidation != null)
    {
        <div class="warning-confirmation">
            <strong>@_lastValidation.Messages.Count(m=>m.Severity=="Warning") @Localizer["WarningsFound"]</strong> @Localizer["ProceedAnywayQuestion"]
            <div class="warning-actions">
                <button class="icon-btn" @onclick="ForceBook">@Localizer["Yes"]</button>
                <button class="icon-btn" @onclick="(()=>{_pendingWarningConfirmation=false;})">@Localizer["Cancel"]</button>
            </div>
        </div>
    }
    <p><strong>@Localizer["File"]:</strong> @_draft.OriginalFileName</p>
    <p><strong>@Localizer["Status"]:</strong> @_draft.Status</p>
    <p>
        <strong>@Localizer["Account"]:</strong>
        <select @onchange="OnAccountChanged" value="@_selectedAccountId">
            <option value="">-- @Localizer["Select"] --</option>
            @foreach (var grp in _groupedAccounts)
            {
                <optgroup label="@grp.Key">
                    @foreach (var acc in grp.Value)
                    {
                        <option value="@acc.Id" selected="@(acc.Id == _selectedAccountId)">@acc.Name</option>
                    }
                </optgroup>
            }
        </select>
    </p>

    @if(_validation != null)
    {
        var globalMessages = _validation.Messages.Where(m=>m.EntryId==null || m.DraftId != Id).ToList();
        if(globalMessages.Any())
        {
            <div class="global-messages">
                <h4>@Localizer["GlobalMessages"]</h4>
                <ul>
                    @foreach(var gm in globalMessages)
                    {
                        var cssClass = gm.Severity=="Error" ? "msg-error" : "msg-warning";
                        <li class="@cssClass">@gm.Message</li>
                    }
                </ul>
            </div>
        }
    }

    <p><strong>@Localizer["TotalAmount"]:</strong> @_draft.Entries.Sum(e => e.Amount)</p>
    @if (_draft.ParentEntryAmount != null)
    { <p class="parent-entry-amount"><strong>@Localizer["ParentEntryAmount"]:</strong> @_draft.ParentEntryAmount</p> }

    <h4>@Localizer["EntriesHeader"] (@_draft.Entries.Count)</h4>
    <div class="draft-entries-container">
        <table class="fm-table wide">
            <thead>
                <tr>
                    <th class="col-icon"></th>
                    <th class="col-date">@Localizer["Th_Date"]</th>
                    <th class="col-valuta">@Localizer["Th_Valuta"]</th>
                    <th class="col-amount">@Localizer["Th_Amount"]</th>
                    <th class="col-currency">@Localizer["Th_Currency"]</th>
                    <th>@Localizer["Th_Subject"]</th>
                    <th class="col-recipient">@Localizer["Th_Recipient"]</th>
                    <th class="col-savings">@Localizer["Th_SavingsPlan"]</th>
                    <th>@Localizer["Th_Description"]</th>
                    <th class="col-announced">@Localizer["Th_Announced"]</th>
                    <th class="col-status">@Localizer["Th_Status"]</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var e in _draft.Entries.OrderBy(e => e.Status == StatementDraftEntryStatus.AlreadyBooked).ThenBy(e => e.BookingDate))
                {
                    var entryMessages = _validation?.Messages.Where(m => m.EntryId == e.Id).ToList() ?? new();
                    var entryErrors = entryMessages.Count(m=>m.Severity=="Error");
                    var entryWarnings = entryMessages.Count(m=>m.Severity=="Warning");
                    var rowClass = e.Status == StatementDraftEntryStatus.AlreadyBooked ? "row-booked" : e.Status == StatementDraftEntryStatus.Announced ? "row-announced" : string.Empty;
                    <tr class="entry-row @rowClass" @onclick="(() => OpenEntry(e.Id))">
                        <td>
                            @if (e.SplitDraftId != null)
                            { <svg title='@Localizer["LinkedSplitDraft"]' aria-label="Split" class="split-icon"><use href="/icons/sprite.svg#link" /></svg> }
                        </td>
                        <td>@e.BookingDate.ToShortDateString()</td>
                        <td>@(e.ValutaDate?.ToShortDateString() ?? "")</td>
                        <td class="amount-cell">@e.Amount</td>
                        <td>@e.CurrencyCode</td>
                        <td class="wrap">@e.Subject</td>
                        <td class="wrap">
                            @if (e.ContactId != null)
                            {
                                var contact = _contacts.FirstOrDefault(a => a.Id == e.ContactId);
                                <div class="entity-display">
                                    @{ var symbolId = contact != null ? GetContactDisplaySymbol(contact.Id) : null; }
                                    @if (symbolId != null)
                                    {
                                        <div class="entity-symbol">
                                            <img src="@($"/api/attachments/{symbolId}/download")" alt="symbol" />
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="entity-symbol-placeholder">
                                            <svg><use href="/icons/sprite.svg#image" /></svg>
                                        </div>
                                    }
                                    <span>@contact?.Name</span>
                                </div>
                            }
                            else { <span>@(string.IsNullOrWhiteSpace(e.RecipientName) ? "" : e.RecipientName)</span> }
                        </td>
                        <td>
                            @if (e.SavingsPlanId != null)
                            {
                                var plan = _savingsPlans.FirstOrDefault(p => p.Id == e.SavingsPlanId);
                                <div class="entity-display">
                                    @{ var sId = plan != null ? GetSavingsPlanDisplaySymbol(plan.Id) : null; }
                                    @if (sId != null)
                                    {
                                        <div class="entity-symbol">
                                            <img src="@($"/api/attachments/{sId}/download")" alt="symbol" />
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="entity-symbol-placeholder">
                                            <svg><use href="/icons/sprite.svg#image" /></svg>
                                        </div>
                                    }
                                    <span>@plan?.Name</span>
                                </div>
                            }
                            else { <span></span> }
                        </td>
                        <td class="wrap">@(string.IsNullOrWhiteSpace(e.BookingDescription) ? "" : e.BookingDescription)</td>
                        <td>@(e.IsAnnounced ? "✓" : "")</td>
                        <td>@e.Status</td>
                    </tr>
                    @if(entryMessages.Any())
                    {
                        <tr class="validation-row @rowClass">
                            <td colspan="11">
                                <div class="validation-content">
                                    <div class="validation-counts">
                                        @if(entryErrors>0){<span class="msg-error">@Localizer["Errors"]: @entryErrors</span>}
                                        @if(entryWarnings>0){<span class="msg-warning">@Localizer["Warnings"]: @entryWarnings</span>}
                                    </div>
                                    <ul>
                                        @foreach(var m in entryMessages)
                                        {
                                            var cssClass = m.Severity=="Error" ? "msg-error" : "msg-warning";
                                            <li class="@cssClass">@m.Message</li>
                                        }
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @if (_draft.Status == StatementDraftStatus.Draft)
    {
        <h4>@Localizer["AddEntryHeader"]</h4>
        <EditForm Model="_form" OnValidSubmit="AddEntryAsync">
            <div class="add-entry-form">
                <InputDate @bind-Value="_form.BookingDate" />
                <InputNumber @bind-Value="_form.Amount" />
                <InputText @bind-Value="_form.Subject" />
                <button type="submit" class="icon-btn">@Localizer["Btn_Add"]</button>
            </div>
        </EditForm>
    }
}

<div class="detail-layout">
    <div class="detail-main"></div>
    @if (_showViewer && _hasFile)
    {
        <div class="file-viewer">
            <div class="file-viewer-header">
                <span>@Localizer["OriginalFileTitle"]</span>
                <button class="icon-btn icon-btn-small" @onclick="ToggleViewer" title='@Localizer["Btn_Close"]' aria-label='@Localizer["Btn_Close"]'><svg><use href="/icons/sprite.svg#clear" /></svg></button>
            </div>
            <iframe src="@_fileUrl"></iframe>
        </div>
    }
</div>
