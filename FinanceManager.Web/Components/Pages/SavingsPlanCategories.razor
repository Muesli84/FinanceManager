@page "/savings-plan-categories"
@rendermode InteractiveServer
@using FinanceManager.Shared.Dtos
@inject IHttpClientFactory ClientFactory
@inject NavigationManager Navigation
@using FinanceManager.Web.Components.Shared
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Components.Pages.SavingsPlanCategories> Localizer
<PageTitle>@Localizer["PageTitle"]</PageTitle>

<Ribbon TTabEnum="SavingsPlanCategories.TabId" Tabs="_tabs" ActiveTab="_activeTab" ActiveTabChanged="OnActiveTabChanged" />

<h3>@Localizer["Title"]</h3>
<table class="fm-table">
    <thead>
        <tr>
            <th>@Localizer["Col_Name"]</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var cat in _categories)
        {
            <tr style="cursor:pointer;" @onclick="() => EditCategory(cat.Id)">
                <td>@cat.Name</td>
            </tr>
        }
        @if(_categories.Count==0)
        {
            <tr><td style="opacity:.6;">@Localizer["Empty"]</td></tr>
        }
    </tbody>
</table>

@code {
    // Ribbon state
    private enum TabId { SavingsPlanCategories }
    private List<Ribbon<TabId>.RibbonTab<TabId>> _tabs = new();
    private TabId _activeTab = TabId.SavingsPlanCategories;
    private Task OnActiveTabChanged(TabId id){ _activeTab = id; return Task.CompletedTask; }

    private void BuildRibbon()
    {
        var actions = new Ribbon<TabId>.RibbonGroup
        {
            Title = Localizer["Ribbon_Group_Actions"],
            Items = new()
            {
                new Ribbon<TabId>.RibbonItem
                {
                    Label = Localizer["Ribbon_New"],
                    IconSvg = "<svg><use href='/icons/sprite.svg#plus'/></svg>",
                    Size = Ribbon<TabId>.RibbonItemSize.Large,
                    Callback = () => { NewCategory(); return Task.CompletedTask; }
                },
                new Ribbon<TabId>.RibbonItem
                {
                    Label = Localizer["Ribbon_Back"],
                    IconSvg = "<svg><use href='/icons/sprite.svg#back'/></svg>",
                    Callback = () => { Back(); return Task.CompletedTask; }
                }
            }
        };
        _tabs = new()
        {
            new Ribbon<TabId>.RibbonTab<TabId>
            {
                Id = TabId.SavingsPlanCategories,
                Title = Localizer["PageTitle"],
                Groups = new(){ actions }
            }
        };
        StateHasChanged();
    }

    private List<SavingsPlanCategoryDto> _categories = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
        BuildRibbon();
    }

    private async Task LoadAsync()
    {
        var http = ClientFactory.CreateClient("Api");
        var resp = await http.GetAsync("/api/savings-plan-categories");
        if (resp.IsSuccessStatusCode)
        {
            _categories = await resp.Content.ReadFromJsonAsync<List<SavingsPlanCategoryDto>>() ?? new();
        }
    }

    private void NewCategory() => Navigation.NavigateTo("/savings-plan-categories/new");
    private void EditCategory(Guid id) => Navigation.NavigateTo($"/savings-plan-categories/{id}");
    private void Back() => Navigation.NavigateTo("/savings-plans");
}