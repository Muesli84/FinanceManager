@using FinanceManager.Application.Reports
@using FinanceManager.Shared.Dtos

<div class="report-kpi @(Clickable ? "clickable" : null)" @onclick="HandleClick">
    @if (DisplayMode == HomeKpiDisplayMode.TotalOnly)
    {
        <div class="kpi-amount-box kpi-kind-@KindClass">
            <svg class="kpi-bg-ico"><use href="@IconHref" /></svg>
            <div class="kpi-amount center">@Amount.ToString("N2")</div>
        </div>
    }
    else if (DisplayMode == HomeKpiDisplayMode.TotalWithComparisons)
    {
            var values = new List<(string Label, decimal Amount)>();
            if (Year.HasValue) { values.Add(("Year", Year.Value)); }
            if (Prev.HasValue) { values.Add(("Prev", Prev.Value)); }
            values.Add(("Now", Amount));
            var maxAbs = values.Select(v => Math.Abs(v.Amount)).DefaultIfEmpty(0m).Max();
            var scale = maxAbs == 0 ? 0 : 40m / maxAbs;
        
        <div class="mini-chart split">
            <div class="bars split">
                @foreach (var v in values)
                {
                    var posH = v.Amount > 0 ? (int)Math.Round((double)(v.Amount * scale)) : 0;
                    var negH = v.Amount < 0 ? (int)Math.Round((double)(-v.Amount * scale)) : 0;
                    <div class="bar-wrap split" title="@($"{v.Label}: {v.Amount:N2}")">
                        <div class="bar-top"><div class="bar-inner pos" style=@($"height:{posH}px")></div></div>
                        <div class="bar-bottom"><div class="bar-inner neg" style=@($"height:{negH}px")></div></div>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
            var ordered = (Series ?? Array.Empty<Point>()).OrderBy(x => x.Date).ToList();
            var maxAbs = ordered.Select(x => Math.Abs(x.Amount)).DefaultIfEmpty(0m).Max();
            var scale = maxAbs == 0 ? 0 : 40m / maxAbs;
        <div class="mini-chart split">
            <div class="bars split">
                @foreach (var p in ordered)
                {
                    var posH = p.Amount > 0 ? (int)Math.Round((double)(p.Amount * scale)) : 0;
                    var negH = p.Amount < 0 ? (int)Math.Round((double)(-p.Amount * scale)) : 0;
                    <div class="bar-wrap split" title="@($"{p.Date:yyyy-MM-dd} {p.Amount:N2}")">
                        <div class="bar-top"><div class="bar-inner pos" style=@($"height:{posH}px")></div></div>
                        <div class="bar-bottom"><div class="bar-inner neg" style=@($"height:{negH}px")></div></div>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public HomeKpiDisplayMode DisplayMode { get; set; }
    [Parameter] public decimal Amount { get; set; }
    [Parameter] public decimal? Prev { get; set; }
    [Parameter] public decimal? Year { get; set; }
    [Parameter] public IReadOnlyList<Point>? Series { get; set; }
    [Parameter] public bool Clickable { get; set; }
    [Parameter] public EventCallback OnClick { get; set; }
    [Parameter] public int PrimaryKind { get; set; }

    public sealed record Point(DateTime Date, decimal Amount);

    private async Task HandleClick()
    {
        if (Clickable && OnClick.HasDelegate)
        {
            await OnClick.InvokeAsync();
        }
    }

    private string IconHref => $"/icons/sprite.svg#{ResolveIconId(PrimaryKind)}";
    private string KindClass => ResolveKindClass(PrimaryKind);

    private static string ResolveIconId(int kind)
    {
        return kind switch
        {
            0 => "postings",   // Bank ? postings (fallback)
            1 => "groups",     // Contact
            2 => "save",       // SavingsPlan
            3 => "postings",   // Security
            _ => "postings"
        };
    }

    private static string ResolveKindClass(int kind)
    {
        return kind switch
        {
            0 => "bank",
            1 => "contacts",
            2 => "savings",
            3 => "securities",
            _ => "postings"
        };
    }
}