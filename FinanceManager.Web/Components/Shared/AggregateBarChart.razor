@using System.Net.Http.Json
@using System.Globalization
@inject HttpClient Http
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Components.Shared.AggregateBarChart> Localizer

<div class="@($"aggregate-chart-wrapper{(Compact? " compact" : string.Empty)}")" aria-busy="@_loading">
    @if (!string.IsNullOrWhiteSpace(Title))
    {
        <h4 class="chart-title">@Title</h4>
    }
    @if (!HideIntervalSelector)
    {
        <div class="interval-selector">
            <label class="lbl-int">@Localizer["LabelInterval"]:</label>
            <select @bind="_period" @bind:after="LoadAsync" aria-label="@Localizer["Aria_SelectInterval"]">
                <option value="Month">@Localizer["Interval_Month"]</option>
                <option value="Quarter">@Localizer["Interval_Quarter"]</option>
                <option value="HalfYear">@Localizer["Interval_HalfYear"]</option>
                <option value="Year">@Localizer["Interval_Year"]</option>
                <option value="AllHistory">@Localizer["Interval_AllHistory"]</option>
            </select>
        </div>
    }

    <div class="chart" style="--bar-color:@PositiveColor;--bar-neg:@NegativeColor;--axis:@AxisColor;">
        @if (_loading && _data.Count == 0)
        {
            <div class="chart-skeleton" role="status" aria-live="polite" style="height:@(BarsHeightPx ?? (Compact?100:180))px;">
                @for (int i=0;i<10;i++)
                {
                    <div class="skeleton-bar" style="animation-delay:@(i*0.06)s"></div>
                }
                <div class="skeleton-labels">
                    @for (int i=0;i<10;i++)
                    {
                        <div class="skeleton-label"></div>
                    }
                </div>
                <span class="visually-hidden">@Localizer["Loading"]</span>
            </div>
        }
        else if (_data.Count == 0)
        {
            <div class="nodata">@Localizer["NoData"]</div>
        }
        else
        {
            var maxAbs = _data.Select(p => Math.Abs(p.Amount)).DefaultIfEmpty(0m).Max();
            var barsHeight = BarsHeightPx ?? (Compact ? 100 : 180);
            var halfHeight = (decimal)barsHeight / 2m;
            var scale = maxAbs == 0 ? 0 : halfHeight / maxAbs;

            <div class="bars-wrapper" style="height:@(barsHeight)px;">
                <div class="bar-row pos">
                    @foreach (var p in _data)
                    {
                        var h = p.Amount > 0 ? (int)Math.Round((double)(p.Amount * scale)) : 0;
                        <div class="bar bar-pos"
                             role="img"
                             aria-label="@BuildAria(p)"
                             title="@BuildTooltip(p)"
                             style="height:@(h)px;"></div>
                    }
                </div>
                <div class="zero-line"></div>
                <div class="bar-row neg">
                    @foreach (var p in _data)
                    {
                        var h = p.Amount < 0 ? (int)Math.Round((double)(-p.Amount * scale)) : 0;
                        <div class="bar bar-neg"
                             role="img"
                             aria-label="@BuildAria(p)"
                             title="@BuildTooltip(p)"
                             style="height:@(h)px;"></div>
                    }
                </div>
            </div>

            <div class="labels-row">
                @{ int idx=0; foreach (var p in _data) { bool show = ShouldShowLabel(idx, _data.Count); <div class="lbl @(show?string.Empty:"skip")" aria-hidden="@(show? "false":"true")">@FormatLabel(p.PeriodStart)</div>; idx++; } }
            </div>

            @if (_loading)
            {
                <div class="chart-loading-overlay" role="status" aria-live="polite">
                    <div class="spinner">
                        <div class="seg a"></div>
                        <div class="seg b"></div>
                        <div class="seg c"></div>
                        <div class="seg d"></div>
                    </div>
                    <span class="loading-text">@Localizer["Loading"]</span>
                </div>
            }
        }
    </div>
</div>

@code {
    [Parameter] public string Endpoint { get; set; } = string.Empty;
    [Parameter] public string? Title { get; set; }
    [Parameter] public string PositiveColor { get; set; } = "#2d6cdf";
    [Parameter] public string NegativeColor { get; set; } = "#c94";
    [Parameter] public string AxisColor { get; set; } = "#555";
    [Parameter] public int? Take { get; set; }
    [Parameter] public int? MaxYearsBack { get; set; }
    [Parameter] public bool HideIntervalSelector { get; set; }
    [Parameter] public string? InitialPeriod { get; set; }
    [Parameter] public bool AutoFit { get; set; } = true;
    [Parameter] public int MaxVisibleLabels { get; set; } = 18;
    [Parameter] public bool Compact { get; set; }
    [Parameter] public int? BarsHeightPx { get; set; }

    private string _period = "Month";
    private bool _loading;
    private bool _multipleYears;
    private readonly List<Point> _data = new();

    private sealed record Point(DateTime PeriodStart, decimal Amount);

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrWhiteSpace(InitialPeriod))
        {
            _period = InitialPeriod!;
        }
        if (!string.IsNullOrWhiteSpace(Endpoint) && _data.Count == 0)
        {
            await LoadAsync();
        }
    }

    private bool ShouldShowLabel(int index, int total)
    {
        if (!AutoFit) { return true; }
        if (total <= MaxVisibleLabels) { return true; }
        int step = (int)Math.Ceiling(total / (double)MaxVisibleLabels);
        return index % step == 0;
    }

    private async Task LoadAsync()
    {
        if (string.IsNullOrWhiteSpace(Endpoint)) { return; }
        _loading = true;
        StateHasChanged();
        try
        {
            var baseUrl = Endpoint.Contains('?') ? $"{Endpoint}&period={_period}" : $"{Endpoint}?period={_period}";
            if (Take.HasValue && Take.Value > 0) { baseUrl += $"&take={Take.Value}"; }
            if (MaxYearsBack.HasValue && MaxYearsBack.Value > 0) { baseUrl += $"&maxYearsBack={MaxYearsBack.Value}"; }
            var resp = await Http.GetAsync(baseUrl);
            if (resp.IsSuccessStatusCode)
            {
                var list = await resp.Content.ReadFromJsonAsync<List<TimeSeriesResponse>>() ?? new();
                _data.Clear();
                _data.AddRange(list.Select(x => new Point(x.PeriodStart, x.Amount)));
                _multipleYears = _data.Select(d => d.PeriodStart.Year).Distinct().Skip(1).Any();
            }
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private string FormatLabel(DateTime d)
    {
        // Culture-aware compact labeling
        var culture = CultureInfo.CurrentUICulture;
        switch (_period)
        {
            case "Month":
                // Use abbreviated month name; append year if multiple years present or first month of year when mixing
                var monthName = culture.DateTimeFormat.GetAbbreviatedMonthName(d.Month);
                if (_multipleYears || d.Month == 1)
                {
                    return string.Concat(monthName, " ", d.ToString("yy", culture));
                }
                return monthName;
            case "Quarter":
                var q = ((d.Month - 1) / 3) + 1;
                return _multipleYears ? $"Q{q} {d:yy}" : $"Q{q}";
            case "HalfYear":
                var h = d.Month <= 6 ? 1 : 2;
                return _multipleYears ? $"H{h} {d:yy}" : $"H{h}";
            case "Year":
                return d.ToString("yyyy", culture);
            default:
                return d.ToString("d", culture);
        }
    }

    private string BuildTooltip(Point p)
    {
        var culture = CultureInfo.CurrentUICulture;
        if (string.Equals(_period, "Quarter", StringComparison.OrdinalIgnoreCase))
        {
            var q = ((p.PeriodStart.Month - 1) / 3) + 1;
            return string.Format(culture, "{0:yyyy}-Q{1} ({2})", p.PeriodStart, q, p.Amount.ToString("N2", culture));
        }
        if (string.Equals(_period, "HalfYear", StringComparison.OrdinalIgnoreCase))
        {
            var h = p.PeriodStart.Month <= 6 ? 1 : 2;
            return string.Format(culture, "{0:yyyy}-H{1} ({2})", p.PeriodStart, h, p.Amount.ToString("N2", culture));
        }
        if (string.Equals(_period, "Year", StringComparison.OrdinalIgnoreCase))
        {
            return string.Format(culture, "{0:yyyy} ({1})", p.PeriodStart, p.Amount.ToString("N2", culture));
        }
        // Month
        var dateStr = p.PeriodStart.ToString("d", culture);
        return string.Format(culture, "{0} ({1})", dateStr, p.Amount.ToString("N2", culture));
    }

    private string BuildAria(Point p) => Localizer["AriaBar", p.PeriodStart.ToString("yyyy-MM-dd"), p.Amount];

    private sealed class TimeSeriesResponse { public DateTime PeriodStart { get; set; } public decimal Amount { get; set; } }
}
